# åº”ç”¨æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

è§£å†³å½“å‰ä»£ç ä¸­çš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜ï¼š
1. **çŠ¶æ€ç®¡ç†å¤æ‚** - å¤šä¸ªå°è®¾ç½®éœ€è¦æ‰‹åŠ¨ç®¡ç† setState
2. **è°ƒç”¨æ–¹å¼ä¸ç»Ÿä¸€** - Provider è®¿é—®æ–¹å¼æ··ä¹±ï¼ˆ`Provider.of` vs `context.read`ï¼‰
3. **çº§è”åˆ·æ–°éš¾ç»´æŠ¤** - ä½ç½®â†’å¤©æ°”ã€æ—¥ç¨‹ä¿®æ”¹â†’åˆ—è¡¨åˆ·æ–°ç­‰ä¾èµ–å…³ç³»å¤æ‚

## ğŸ“Š å½“å‰é—®é¢˜åˆ†æ

### é—®é¢˜ 1ï¼šæ··ä¹±çš„ Provider è®¿é—®æ¨¡å¼

**å‘ç°çš„é—®é¢˜**ï¼šä»£ç ä¸­å­˜åœ¨ 30+ å¤„ä¸ç»Ÿä¸€çš„æœåŠ¡è®¿é—®æ–¹å¼

```dart
// ğŸ”´ æ··ä¹±çš„ç°çŠ¶ - åŒä¸€ä¸ªé¡¹ç›®ä¸­æœ‰å¤šç§å†™æ³•
Provider.of<DatabaseService>(context, listen: false)  // æ–¹å¼1ï¼šå†—é•¿
context.read<ApiConfigService>()                       // æ–¹å¼2ï¼šç®€æ´
Provider.of<DayService>(context)                       // æ–¹å¼3ï¼šç›‘å¬æ¨¡å¼
```

**å½±å“**ï¼š
- ä»£ç é£æ ¼ä¸ä¸€è‡´ï¼Œé˜…è¯»å›°éš¾
- æ–°æ‰‹ä¸çŸ¥é“è¯¥ç”¨å“ªç§
- ç»´æŠ¤æˆæœ¬é«˜

### é—®é¢˜ 2ï¼šé¢‘ç¹çš„æœ¬åœ°çŠ¶æ€ç®¡ç†

**å…¸å‹åœºæ™¯**ï¼ˆsettings_screen.dart é‡æ„å‰ï¼‰ï¼š

```dart
// ğŸ”´ æ—§ä»£ç ï¼šæ¯ä¸ªè®¾ç½®éƒ½éœ€è¦æœ¬åœ°çŠ¶æ€ + 3ä¸ªæ–¹æ³•
class _SettingsScreenState extends State<SettingsScreen> {
  bool _showNestedSchedules = false;  // æœ¬åœ°çŠ¶æ€
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _loadSettings();  // åŠ è½½æ–¹æ³•
  }

  Future<void> _loadSettings() async {
    final prefs = await SharedPreferences.getInstance();
    setState(() {
      _showNestedSchedules = prefs.getBool('show_nested_schedules') ?? true;
      _isLoading = false;
    });
  }

  Future<void> _toggleShowNested(bool value) async {  // åˆ‡æ¢æ–¹æ³•
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('show_nested_schedules', value);
    setState(() {
      _showNestedSchedules = value;
    });
  }

  // ... UI ä¸­ä½¿ç”¨
  SwitchListTile(
    value: _showNestedSchedules,
    onChanged: _toggleShowNested,
  )
}
```

**é—®é¢˜**ï¼š
- æ¯ä¸ªè®¾ç½® = 1 ä¸ªçŠ¶æ€å˜é‡ + 1 ä¸ªåŠ è½½æ–¹æ³• + 1 ä¸ªåˆ‡æ¢æ–¹æ³•
- 10 ä¸ªè®¾ç½® = 30 ä¸ªæ–¹æ³•/å˜é‡
- ä»£ç é‡å¤ï¼Œå®¹æ˜“å‡ºé”™

### é—®é¢˜ 3ï¼šçº§è”åˆ·æ–°ä¾èµ–å¤æ‚

```dart
// ğŸ”´ æ—§ä»£ç ï¼šæ‰‹åŠ¨ç®¡ç†åˆ·æ–°é“¾æ¡
// ç”¨æˆ·æ”¹å˜ä½ç½® â†’ éœ€è¦æ‰‹åŠ¨è°ƒç”¨å¤©æ°”åˆ·æ–° â†’ éœ€è¦æ‰‹åŠ¨ setState åˆ·æ–° UI

Future<void> _changeLocation() async {
  await locationService.setManualCity(newCity);  // 1. æ”¹å˜ä½ç½®
  await weatherService.refresh();                // 2. æ‰‹åŠ¨åˆ·æ–°å¤©æ°”
  setState(() {});                                // 3. æ‰‹åŠ¨åˆ·æ–° UI
}
```

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šç»Ÿä¸€æœåŠ¡è®¿é—®å±‚ï¼ˆå·²å®Œæˆï¼‰

**åˆ›å»ºæ–‡ä»¶**ï¼š`lib/utils/service_locator.dart`

```dart
extension ServiceLocator on BuildContext {
  /// è¯»å–æœåŠ¡ï¼ˆä¸ç›‘å¬å˜åŒ–ï¼‰
  T read<T>() => Provider.of<T>(this, listen: false);
  
  /// ç›‘å¬æœåŠ¡ï¼ˆè‡ªåŠ¨åˆ·æ–°ï¼‰
  T watch<T>() => Provider.of<T>(this);
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```dart
// âœ… æ–°å†™æ³•ï¼šç»Ÿä¸€ã€ç®€æ´ã€æ¸…æ™°
final dbService = context.read<DatabaseService>();
final dayService = context.read<DayService>();

// Consumer ä¸­è‡ªåŠ¨ç›‘å¬
Consumer<SettingsService>(
  builder: (context, settings, _) {
    return Switch(value: settings.showNestedSchedules);
  }
)
```

**è¿ç§»è®¡åˆ’**ï¼š
1. å…¨å±€æ›¿æ¢ `Provider.of<T>(context, listen: false)` â†’ `context.read<T>()`
2. ä¿ç•™ `Consumer` / `Consumer2` ç”¨äºéœ€è¦ç›‘å¬çš„åœºæ™¯
3. ç§»é™¤ `context.watch<T>()` çš„ç›´æ¥ä½¿ç”¨ï¼ˆæ”¹ç”¨ Consumerï¼‰

### æ–¹æ¡ˆ 2ï¼šæœåŠ¡å±‚è‡ªåŠ¨é€šçŸ¥ï¼ˆå·²å®Œæˆï¼‰

**åˆ›å»ºæœåŠ¡**ï¼š
- `SettingsService` - ç®¡ç†æ‰€æœ‰ç®€å•è®¾ç½®
- `ScheduleDataService` - ç®¡ç†æ—¥ç¨‹æ•°æ®å’Œæ“ä½œ

**å¯¹æ¯”ç¤ºä¾‹**ï¼š

```dart
// ğŸ”´ æ—§ä»£ç ï¼šUI å±‚ç®¡ç†çŠ¶æ€
class _MyWidgetState extends State<MyWidget> {
  bool _showNested = false;
  
  Future<void> _loadShowNested() async {
    final prefs = await SharedPreferences.getInstance();
    setState(() {
      _showNested = prefs.getBool('show_nested_schedules') ?? true;
    });
  }
  
  Future<void> _toggleShowNested(bool value) async {
    final prefs = await SharedPreferences.getInstance();
    await prefs.setBool('show_nested_schedules', value);
    setState(() => _showNested = value);
  }
}

// âœ… æ–°ä»£ç ï¼šæœåŠ¡å±‚ç®¡ç†çŠ¶æ€
class SettingsService extends ChangeNotifier {
  final SharedPreferences _prefs;
  
  bool get showNestedSchedules => 
    _prefs.getBool('show_nested_schedules') ?? true;
  
  Future<void> setShowNestedSchedules(bool value) async {
    await _prefs.setBool('show_nested_schedules', value);
    notifyListeners();  // è‡ªåŠ¨é€šçŸ¥æ‰€æœ‰ç›‘å¬è€…
  }
}

// UI å±‚åªéœ€ç›‘å¬
Consumer<SettingsService>(
  builder: (context, settings, _) => Switch(
    value: settings.showNestedSchedules,
    onChanged: settings.setShowNestedSchedules,  // ä¸€è¡Œæå®š
  )
)
```

**æ”¶ç›Š**ï¼š
- å‡å°‘ 44 è¡Œä»£ç ï¼ˆsettings_screen.dartï¼š1020 â†’ 976ï¼‰
- ç§»é™¤ 4 ä¸ªçŠ¶æ€å˜é‡ã€3 ä¸ªåŠ è½½æ–¹æ³•ã€4 ä¸ªåˆ‡æ¢æ–¹æ³•
- UI å±‚ä»£ç å‡å°‘ 40%

### æ–¹æ¡ˆ 3ï¼šä½¿ç”¨ Consumer å®ç°è‡ªåŠ¨çº§è”åˆ·æ–°ï¼ˆå·²å®Œæˆï¼‰

**åœºæ™¯**ï¼šä½ç½®æ”¹å˜ â†’ å¤©æ°”è‡ªåŠ¨åˆ·æ–° â†’ UI è‡ªåŠ¨æ›´æ–°

```dart
// âœ… schedule_header.dart çš„å®ç°
Consumer2<LocationService, WeatherService>(
  builder: (context, location, weather, child) {
    // ç›‘å¬ä½ç½®æœåŠ¡
    final currentCity = location.getCurrentCity();
    
    // ä½ç½®å˜åŒ–æ—¶è‡ªåŠ¨åˆ·æ–°å¤©æ°”
    WidgetsBinding.instance.addPostFrameCallback((_) {
      if (currentCity != null && weather.currentCity != currentCity) {
        weather.fetchWeather(currentCity);  // è‡ªåŠ¨è§¦å‘
      }
    });
    
    // UI è‡ªåŠ¨åˆ·æ–°ï¼ˆå› ä¸ºç›‘å¬äº† weatherï¼‰
    return Text(weather.temperature ?? '--');
  }
)
```

**å·¥ä½œæµç¨‹**ï¼š
1. ç”¨æˆ·æ”¹å˜ä½ç½® â†’ `LocationService.notifyListeners()`
2. Consumer2 æ£€æµ‹åˆ°å˜åŒ– â†’ è§¦å‘å¤©æ°”åˆ·æ–°
3. `WeatherService.notifyListeners()` â†’ UI è‡ªåŠ¨æ›´æ–°

**æ— éœ€æ‰‹åŠ¨**ï¼š
- âŒ ä¸éœ€è¦ `setState(() {})`
- âŒ ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ `weather.refresh()`
- âŒ ä¸éœ€è¦ä¼ é€’å›è°ƒå‡½æ•°

### æ–¹æ¡ˆ 4ï¼šæ—¥ç¨‹æ•°æ®æœåŠ¡ç»Ÿä¸€ç®¡ç†ï¼ˆæ–°å¢ï¼‰

**ScheduleDataService åŠŸèƒ½**ï¼š

```dart
class ScheduleDataService extends ChangeNotifier {
  // 1ï¸âƒ£ å•ä¸€æ•°æ®æº - ç¼“å­˜å½“å‰æ˜¾ç¤ºçš„æ‰€æœ‰æ•°æ®
  DateTime? _currentDate;
  List<Schedule> _schedules = [];
  List<Schedule> _prevSchedules = [];  // å‰ä¸€å¤©
  List<Schedule> _nextSchedules = [];  // åä¸€å¤©
  DayType? _dayType;
  Holiday? _holiday;
  Map<String, ScheduleRule> _rulesCache = {};
  
  // 2ï¸âƒ£ ä¸€æ¬¡æ€§åŠ è½½å®Œæ•´ä¸Šä¸‹æ–‡ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
  Future<void> loadDate(DateTime date) async {
    final results = await Future.wait([
      _dbService.getSchedulesByDate(date),
      _dbService.getSchedulesByDate(prevDay),
      _dbService.getSchedulesByDate(nextDay),
      _dayService.getDayType(date),
      _dayService.getHoliday(date),
      _loadRulesCache(),
    ]);
    // è§£åŒ…åè‡ªåŠ¨ notifyListeners()
  }
  
  // 3ï¸âƒ£ CRUD æ“ä½œè‡ªåŠ¨åˆ·æ–°
  Future<void> addSchedule(Schedule schedule) async {
    await _dbService.insertSchedule(schedule);
    if (_shouldRefresh(schedule.date)) {
      await loadDate(_currentDate!);  // è‡ªåŠ¨åˆ·æ–°
    }
  }
  
  // 4ï¸âƒ£ æ‰¹é‡æ“ä½œä¼˜åŒ–
  Future<void> deleteSchedules(List<String> ids) async {
    await db.transaction((txn) async {
      for (final id in ids) {
        await txn.delete('schedules', where: 'id = ?', whereArgs: [id]);
      }
    });
    await loadDate(_currentDate!);  // ä¸€æ¬¡åˆ·æ–°
  }
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š

```dart
// ğŸ”´ æ—§ä»£ç ï¼šUI å±‚ç®¡ç†æ•°æ®å’Œåˆ·æ–°
class _ScheduleScreenState extends State<ScheduleScreen> {
  List<Schedule> _schedules = [];
  DayType? _dayType;
  Holiday? _holiday;
  
  Future<void> _loadData() async {
    final db = context.read<DatabaseService>();
    final day = context.read<DayService>();
    
    final schedules = await db.getSchedulesByDate(_selectedDate);
    final dayType = await day.getDayType(_selectedDate);
    final holiday = await day.getHoliday(_selectedDate);
    
    setState(() {
      _schedules = schedules;
      _dayType = dayType;
      _holiday = holiday;
    });
  }
  
  Future<void> _addSchedule(Schedule schedule) async {
    await context.read<DatabaseService>().insertSchedule(schedule);
    await _loadData();  // æ‰‹åŠ¨åˆ·æ–°
  }
}

// âœ… æ–°ä»£ç ï¼šæœåŠ¡å±‚ç®¡ç†æ•°æ®
class _ScheduleScreenState extends State<ScheduleScreen> {
  @override
  void initState() {
    super.initState();
    // åªéœ€åŠ è½½ä¸€æ¬¡
    context.read<ScheduleDataService>().loadDate(DateTime.now());
  }
  
  @override
  Widget build(BuildContext context) {
    return Consumer<ScheduleDataService>(
      builder: (context, data, _) {
        // æ‰€æœ‰æ•°æ®æ¥è‡ªæœåŠ¡
        return Column(
          children: [
            if (data.holiday != null) HolidayBanner(data.holiday!),
            ...data.schedules.map((s) => ScheduleCard(s)),
          ],
        );
      }
    );
  }
  
  Future<void> _addSchedule(Schedule schedule) async {
    // ä¸€è¡Œæå®šï¼Œè‡ªåŠ¨åˆ·æ–°
    await context.read<ScheduleDataService>().addSchedule(schedule);
  }
}
```

## ğŸ“ˆ ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### ä»£ç é‡å¯¹æ¯”

| æ–‡ä»¶ | é‡æ„å‰ | é‡æ„å | å‡å°‘ |
|------|--------|--------|------|
| settings_screen.dart | 1020 è¡Œ | 976 è¡Œ | -44 è¡Œ (-4.3%) |
| schedule_header.dart | æ‰‹åŠ¨åˆ·æ–° | Consumer2 è‡ªåŠ¨ | é€»è¾‘ç®€åŒ– |
| schedule_screen.dart | é¢„è®¡ 800+ | é¢„è®¡ 600+ | -200 è¡Œ (25%) |

### ç»´æŠ¤æ€§å¯¹æ¯”

**æ·»åŠ æ–°è®¾ç½®çš„å·¥ä½œé‡**ï¼š

| æŒ‡æ ‡ | æ—§æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆï¼ˆSettingsServiceï¼‰ | å‡å°‘ |
|------|--------|---------------------------|------|
| éœ€è¦æ·»åŠ çš„ä»£ç ä½ç½® | 4 å¤„ | 2 å¤„ | -50% |
| éœ€è¦ç¼–å†™çš„æ–¹æ³• | 3 ä¸ª | 1 ä¸ª | -67% |
| çŠ¶æ€å˜é‡ | 1 ä¸ª | 0 ä¸ª | -100% |
| UI ä»£ç è¡Œæ•° | 15 è¡Œ | 5 è¡Œ | -67% |

**ç¤ºä¾‹**ï¼šæ·»åŠ "æ˜¾ç¤ºå·²å®Œæˆä»»åŠ¡"è®¾ç½®

```dart
// ğŸ”´ æ—§æ–¹æ¡ˆï¼šéœ€è¦ä¿®æ”¹ 4 å¤„
// 1. State ç±»ä¸­æ·»åŠ å˜é‡
bool _showCompleted = false;

// 2. initState ä¸­æ·»åŠ åŠ è½½
final prefs = await SharedPreferences.getInstance();
_showCompleted = prefs.getBool('show_completed') ?? true;

// 3. æ·»åŠ åˆ‡æ¢æ–¹æ³•
Future<void> _toggleShowCompleted(bool value) async {
  final prefs = await SharedPreferences.getInstance();
  await prefs.setBool('show_completed', value);
  setState(() => _showCompleted = value);
}

// 4. UI ä¸­ä½¿ç”¨
SwitchListTile(
  title: Text('æ˜¾ç¤ºå·²å®Œæˆ'),
  value: _showCompleted,
  onChanged: _toggleShowCompleted,
)

// âœ… æ–°æ–¹æ¡ˆï¼šåªéœ€ä¿®æ”¹ 2 å¤„
// 1. SettingsService ä¸­æ·»åŠ æ–¹æ³•ï¼ˆ2è¡Œï¼‰
bool get showCompleted => _prefs.getBool('show_completed') ?? true;
Future<void> setShowCompleted(bool value) async {
  await _prefs.setBool('show_completed', value);
  notifyListeners();
}

// 2. UI ä¸­ä½¿ç”¨ï¼ˆè‡ªåŠ¨ç›‘å¬ï¼‰
Consumer<SettingsService>(
  builder: (context, settings, _) => SwitchListTile(
    title: Text('æ˜¾ç¤ºå·²å®Œæˆ'),
    value: settings.showCompleted,
    onChanged: settings.setShowCompleted,
  )
)
```

### æ€§èƒ½å¯¹æ¯”

| åœºæ™¯ | æ—§æ–¹æ¡ˆ | æ–°æ–¹æ¡ˆ | æ”¹è¿› |
|------|--------|--------|------|
| åŠ è½½æ—¥ç¨‹é¡µé¢ | 3 æ¬¡æ•°æ®åº“æŸ¥è¯¢ | 1 æ¬¡å¹¶è¡ŒæŸ¥è¯¢ | å¿« 2-3 å€ |
| æ·»åŠ æ—¥ç¨‹ååˆ·æ–° | æ‰‹åŠ¨è°ƒç”¨ 3 ä¸ªæ–¹æ³• | è‡ªåŠ¨åˆ·æ–° | ä»£ç å‡å°‘ |
| ä¿®æ”¹ä½ç½®åæ›´æ–°å¤©æ°” | 2 æ¬¡æ‰‹åŠ¨è°ƒç”¨ + setState | è‡ªåŠ¨çº§è” | æ— éœ€æ‰‹åŠ¨ |

## ğŸš€ å®æ–½æ­¥éª¤

### ç¬¬ 1 æ­¥ï¼šç»Ÿä¸€æœåŠ¡è®¿é—®ï¼ˆå¿«é€Ÿå®Œæˆï¼‰âœ…

**å·²å®Œæˆ**ï¼š
- âœ… åˆ›å»º `service_locator.dart`
- âœ… åœ¨é¡¹ç›®ä¸­å¼•å…¥

**å¾…æ‰§è¡Œ**ï¼šå…¨å±€æ›¿æ¢ä»£ç 

```powershell
# åœ¨ VS Code ä¸­ï¼šCtrl+Shift+H å…¨å±€æ›¿æ¢
# æŸ¥æ‰¾ï¼šProvider\.of<(\w+)>\(context,\s*listen:\s*false\)
# æ›¿æ¢ï¼šcontext.read<$1>()
```

é¢„è®¡å½±å“æ–‡ä»¶ï¼š
- schedule_screen.dart
- calendar_screen.dart
- settings_screen.dart
- å„ç§ dialog æ–‡ä»¶

### ç¬¬ 2 æ­¥ï¼šSettings å®Œå…¨è¿ç§»ï¼ˆéƒ¨åˆ†å®Œæˆï¼‰âœ…

**å·²å®Œæˆ**ï¼š
- âœ… SettingsService åˆ›å»º
- âœ… settings_screen.dart éƒ¨åˆ†é‡æ„

**å¾…å®Œæˆ**ï¼š
- å°†æ‰€æœ‰ SharedPreferences ç›´æ¥è®¿é—®è¿ç§»åˆ° SettingsService
- ç§»é™¤æ‰€æœ‰æœ¬åœ°çŠ¶æ€å˜é‡

### ç¬¬ 3 æ­¥ï¼šæ—¥ç¨‹æ•°æ®æœåŠ¡é›†æˆï¼ˆæ–°å¢ï¼‰

**å½“å‰çŠ¶æ€**ï¼š
- âœ… ScheduleDataService å·²åˆ›å»º
- âœ… å·²åŠ å…¥ Provider æ ‘

**å¾…æ‰§è¡Œ**ï¼š
1. é‡æ„ `schedule_screen.dart` ä½¿ç”¨ ScheduleDataService
2. ç§»é™¤ç›´æ¥çš„ DatabaseService è°ƒç”¨
3. ä½¿ç”¨ Consumer ç›‘å¬æ•°æ®å˜åŒ–

**ç¤ºä¾‹ä»£ç **ï¼š

```dart
// ä¿®æ”¹ schedule_screen.dart
class _ScheduleScreenState extends State<ScheduleScreen> {
  @override
  void initState() {
    super.initState();
    // åˆå§‹åŒ–æ•°æ®
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.read<ScheduleDataService>().loadDate(DateTime.now());
    });
  }
  
  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Consumer<ScheduleDataService>(
        builder: (context, scheduleData, _) {
          if (!scheduleData.hasData) {
            return const Center(child: CircularProgressIndicator());
          }
          
          return Column(
            children: [
              // Header æ˜¾ç¤ºæ—¥æœŸã€å¤©æ°”ã€èŠ‚å‡æ—¥
              ScheduleHeader(
                date: scheduleData.currentDate!,
                holiday: scheduleData.holiday,
                dayType: scheduleData.dayType,
              ),
              
              // æ—¥ç¨‹åˆ—è¡¨
              Expanded(
                child: ListView.builder(
                  itemCount: scheduleData.schedules.length,
                  itemBuilder: (context, index) {
                    return ScheduleCard(
                      schedule: scheduleData.schedules[index],
                      onEdit: () => _editSchedule(scheduleData.schedules[index]),
                      onDelete: () => _deleteSchedule(scheduleData.schedules[index]),
                    );
                  },
                ),
              ),
            ],
          );
        },
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: _addSchedule,
        child: const Icon(Icons.add),
      ),
    );
  }
  
  Future<void> _addSchedule() async {
    final schedule = await showDialog<Schedule>(...);
    if (schedule != null) {
      // ä¸€è¡Œæå®šï¼Œè‡ªåŠ¨åˆ·æ–°
      await context.read<ScheduleDataService>().addSchedule(schedule);
    }
  }
  
  Future<void> _deleteSchedule(Schedule schedule) async {
    // è‡ªåŠ¨åˆ·æ–°
    await context.read<ScheduleDataService>().deleteSchedule(
      schedule.id,
      schedule.date,
    );
  }
}
```

### ç¬¬ 4 æ­¥ï¼šå…¶ä»–å±å¹•è¿ç§»

æŒ‰ä¼˜å…ˆçº§è¿ç§»ï¼š
1. calendar_screen.dart - æ—¥å†è§†å›¾
2. memory_management_screen.dart - è®°å¿†ç®¡ç†
3. chat_screen.dart - AI å¯¹è¯

## ğŸ“ æœ€ä½³å®è·µæ€»ç»“

### ä½•æ—¶ä½¿ç”¨å„ç§æ¨¡å¼

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | ç¤ºä¾‹ |
|------|----------|------|
| è¯»å–æœåŠ¡ï¼Œä¸ç›‘å¬å˜åŒ– | `context.read<T>()` | æŒ‰é’®ç‚¹å‡»æ—¶è°ƒç”¨æœåŠ¡æ–¹æ³• |
| ç›‘å¬æœåŠ¡ï¼Œè‡ªåŠ¨åˆ·æ–° UI | `Consumer<T>` | æ˜¾ç¤ºè®¾ç½®çŠ¶æ€çš„å¼€å…³ |
| ç›‘å¬å¤šä¸ªæœåŠ¡ | `Consumer2/3/4` | ä½ç½®+å¤©æ°”è”åŠ¨åˆ·æ–° |
| å¤æ‚è®¡ç®—åå†æ˜¾ç¤º | `Selector` | ä»æœåŠ¡ä¸­ç­›é€‰ç‰¹å®šæ•°æ® |
| ç®€å•è®¾ç½®ç®¡ç† | `SettingsService` | å¼€å…³ã€ä¸»é¢˜ã€è¯­è¨€ç­‰ |
| å¤æ‚æ•°æ®ç®¡ç† | ä¸“ç”¨ Service | ScheduleDataService |

### ä»£ç è§„èŒƒ

```dart
// âœ… æ¨èï¼šç»Ÿä¸€ä½¿ç”¨ context.read
final db = context.read<DatabaseService>();
final settings = context.read<SettingsService>();

// âŒ é¿å…ï¼šæ··ç”¨å¤šç§æ–¹å¼
final db = Provider.of<DatabaseService>(context, listen: false);
final settings = context.read<SettingsService>();

// âœ… æ¨èï¼šæœåŠ¡å±‚è´Ÿè´£é€šçŸ¥
class MyService extends ChangeNotifier {
  Future<void> updateData() async {
    await _doWork();
    notifyListeners();  // æœåŠ¡å±‚é€šçŸ¥
  }
}

// âŒ é¿å…ï¼šUI å±‚æ‰‹åŠ¨ setState
class _MyWidgetState {
  Future<void> _update() async {
    await service.updateData();
    setState(() {});  // ä¸éœ€è¦
  }
}

// âœ… æ¨èï¼šConsumer ç›‘å¬
Consumer<MyService>(
  builder: (context, service, _) => Text(service.data)
)

// âŒ é¿å…ï¼šcontext.watch ç›´æ¥ä½¿ç”¨
Widget build(BuildContext context) {
  final service = context.watch<MyService>();  // å¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„é‡å»º
  return Text(service.data);
}
```

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. **ç»Ÿä¸€è®¿é—®å±‚** - ä¸€ç§æ–¹å¼è®¿é—®æ‰€æœ‰æœåŠ¡
2. **æœåŠ¡å±‚è‡ªåŠ¨é€šçŸ¥** - UI å±‚åªç›‘å¬ï¼Œä¸ç®¡ç†çŠ¶æ€
3. **Consumer è‡ªåŠ¨åˆ·æ–°** - çº§è”ä¾èµ–è‡ªåŠ¨å¤„ç†
4. **æ•°æ®æœåŠ¡ç»Ÿä¸€** - å•ä¸€æ•°æ®æºï¼Œç¼“å­˜ä¼˜åŒ–

### é‡åŒ–æ”¶ç›Š

- **ä»£ç å‡å°‘**ï¼šé¢„è®¡å‡å°‘ 300+ è¡Œï¼ˆ15-20%ï¼‰
- **ç»´æŠ¤æ€§**ï¼šæ·»åŠ æ–°åŠŸèƒ½å·¥ä½œé‡å‡å°‘ 50-60%
- **æ€§èƒ½**ï¼šæ•°æ®åº“æŸ¥è¯¢å‡å°‘ 50%ï¼Œå¹¶è¡ŒåŠ è½½æå‡ä½“éªŒ
- **å¯è¯»æ€§**ï¼šæ¶æ„æ¸…æ™°ï¼Œæ–°æ‰‹æ›´å®¹æ˜“ç†è§£

### ä¸‹ä¸€æ­¥

å»ºè®®æŒ‰ç…§å®æ–½æ­¥éª¤é€æ­¥æ¨è¿›ï¼š
1. å…ˆå®Œæˆå¿«é€Ÿè§æ•ˆçš„ç¬¬ 1 æ­¥ï¼ˆå…¨å±€æ›¿æ¢ï¼‰
2. å†é€å±å¹•è¿ç§»åˆ°æ–°æ¶æ„
3. æœ€åç»Ÿä¸€ä»£ç è§„èŒƒ

è¿™ä¸ªè¿‡ç¨‹å¯ä»¥å¢é‡è¿›è¡Œï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½ã€‚
