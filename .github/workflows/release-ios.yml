name: Build and Release iOS

on:
  push:
    tags:
      - 'v*.*.*'  # 匹配版本标签，如 v1.0.0
  workflow_dispatch:  # 允许手动触发
    inputs:
      upload_testflight:
        description: 'Upload to TestFlight'
        required: false
        default: 'false'

jobs:
  build-ios-signed:
    name: Build Signed iOS IPA
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'
        cache: true
    
    - name: Create API keys file
      run: |
        cp lib/config/api_keys.dart.example lib/config/api_keys.dart
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Run tests
      run: flutter test
      continue-on-error: true
    
    # 配置签名证书（需要在仓库设置中配置 secrets）
    - name: Install Apple Certificate
      if: ${{ secrets.IOS_CERTIFICATE_P12 }}
      uses: apple-actions/import-codesign-certs@v2
      with:
        p12-file-base64: ${{ secrets.IOS_CERTIFICATE_P12 }}
        p12-password: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
    
    - name: Install Provisioning Profile
      if: ${{ secrets.IOS_PROVISIONING_PROFILE }}
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo -n "${{ secrets.IOS_PROVISIONING_PROFILE }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
    
    - name: Build iOS with signing
      if: ${{ secrets.IOS_CERTIFICATE_P12 }}
      run: |
        flutter build ios --release
        cd build/ios/iphoneos
        mkdir Payload
        cp -r Runner.app Payload/
        zip -r SelfDisciplineAssistant-Signed.ipa Payload
    
    - name: Build iOS without signing
      if: ${{ !secrets.IOS_CERTIFICATE_P12 }}
      run: |
        flutter build ios --release --no-codesign
        cd build/ios/iphoneos
        mkdir Payload
        cp -r Runner.app Payload/
        zip -r SelfDisciplineAssistant-Unsigned.ipa Payload
    
    - name: Upload IPA to artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa-release
        path: build/ios/iphoneos/*.ipa
        retention-days: 90
    
    - name: Upload to TestFlight
      if: ${{ github.event.inputs.upload_testflight == 'true' && secrets.APPSTORE_API_KEY }}
      run: |
        xcrun altool --upload-app --type ios --file build/ios/iphoneos/*.ipa \
          --apiKey ${{ secrets.APPSTORE_API_KEY }} \
          --apiIssuer ${{ secrets.APPSTORE_ISSUER_ID }}
    
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: build/ios/iphoneos/*.ipa
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
