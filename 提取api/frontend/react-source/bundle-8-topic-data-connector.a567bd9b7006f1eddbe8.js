"use strict";(self.homePageWebpackChunks=self.homePageWebpackChunks||[]).push([["topic-data-connector"],{1963:function(t,e,i){i.r(e),i.d(e,{FeedType:function(){return s.D},FollowState:function(){return o.$},InterestsSearchServiceClient:function(){return a.i},ResizeServiceImage:function(){return r.nx},ToolingInfo:function(){return q},TopicDataActions:function(){return h.Z},TopicDataConnector:function(){return u.t},TopicDataReducer:function(){return l.E},TopicSourceNameEnum:function(){return n.r},TopicsFetchState:function(){return c.U},TopicsServiceClient:function(){return y.B},WindowsTopicDataProvider:function(){return C}});var s=i(85515),o=i(98137),n=i(80900),c=i(62140),a=i(13969),r=i(35320),h=i(69402),u=i(48312),l=i(69593),p=i(65022),d=i(15003),f=i(50677),w=i(56408),g=i(75575),y=i(64334),m=i(12870),v=i(16507),T=i(19548),F=i(89980),S=i(7187),I=i(68613),M=i(69927),b=i(98216),k=i(86948),$=i(53829),R=i(29252);class C{static getInstance(){return this.instance||(this.instance=new C),this.instance}static resetInstance(){this.instance=new C}constructor(){this.fetchedAllFollowedTopics=!1,this.fetchedAllRecommendedTopics=!1,this.fetchedAllTopics=!1,this.serviceClient=new y.B(window.fetch.bind(window)),this.useUserCreatedOrder=m.Rb.CurrentFlights.indexOf("prg-navfr-t")>-1,this.topicDataState={followedTopicIds:[],followedTopicNames:[],topicListIds:[],topicListMap:{},topicMap:{},recommendedTopics:[],topicsFetchState:null}}getCurrentState(){return this.topicDataState}async followTopic(t,e,i){const s=v.n.isNotNullOrUndefined(await this.getFollowedTopic(t,e,i));return s&&((0,f.FH)(w.u.InterestsChange),(0,d.TI)(3),(0,R.r8)()),s}async getFollowedTopic(t,e,i){let n=null;if(t&&(n=await this.getTopic(t)),!(0,S.isNullOrUndefined)(n)&&(n.followState!==o.$.Followed||i)||e){const t=n&&n.feedType!==s.D.UserQuery?n:null,i=n&&n.feedType===s.D.UserQuery?n.name:e,c=await this.updateTopicFollowingState(t,o.$.Followed,i);c&&(n=await this.getTopic((null==t?void 0:t.id)||c.targetId))}return(0,S.isNullOrUndefined)(n)||n.followState!==o.$.Followed?void 0:n}async getFollowedTopics(t){let e=this.topicDataState.followedTopicIds;return this.fetchedAllFollowedTopics&&!t||(t=t||await this.gettingTopicsAfterMigration(),await this.fetchFollowedTopics(t)&&(e=this.topicDataState.followedTopicIds,t&&(0,$.nB)())),e}async getOneServiceFollowedTopics(){try{return await this.serviceClient.getFollowedTopics(!1,this.useUserCreatedOrder)}catch(t){this.trackAppError({...p._xy,message:"Failed fetching one service followed topics",pb:{...p._xy.pb,customMessage:`Failed fetching one service followed topics. ${t&&t.message}`}})}}async getRecommendedTopics(){return this.fetchedAllRecommendedTopics||await this.fetchRecommendedTopics(),this.topicDataState.recommendedTopics}async getRelatedTopics(t,e){return this.getTopic(t).then(t=>this.serviceClient.getRelatedTopics(t,e))}async getTopic(t){let e=this.topicDataState.topicMap[t];return(0,S.isUndefined)(e)&&await this.fetchTopic(t)&&(e=this.topicDataState.topicMap[t]),e}async getTopics(t){return this.fetchedAllTopics||await this.fetchTopics(t),this.topicDataState.topicMap}async unfollowTopic(t,e){const i=await this.getTopic(t),s=await this.updateTopicFollowingState(i,o.$.Unfollowed,null,e);return s&&!e&&((0,f.FH)(w.u.InterestsChange),(0,d.TI)(3),(0,R.r8)()),s}async restoreDefaultTopics(){try{return await this.serviceClient.restoreDefaultTopics(),(0,f.FH)(w.u.InterestsChange),(0,d.TI)(3),(0,R.r8)(),await g.S.purgeCacheAsync(g.p.followedTopics),await this.getFollowedTopics(!0),!0}catch(t){return this.trackAppError({...p.lr4,message:"Failed restoring default set of followed interests",pb:{...p.lr4.pb,customMessage:`Error: ${t&&t.message}`}}),!1}}subscribeTopicDataProviderState(t){t&&(this.stateChangeCallback=t,t(this.topicDataState))}async fetchFollowedTopics(t){try{const e=await this.serviceClient.getFollowedTopics(t,this.useUserCreatedOrder);return this.setFollowedTopics(e,t),this.fetchedAllFollowedTopics=!0,!0}catch(t){return this.topicDataState.topicsFetchState=c.U.Failed,this.trackAppError({...p._xy,message:"Failed fetching followed topics",pb:{...p._xy.pb,customMessage:`Failed fetching followed topics. ${t&&t.message}`}}),!1}}async fetchRecommendedTopics(){try{const t=await this.serviceClient.getRecommendedTopics();return this.updateRecommendedTopics(t),this.fetchedAllRecommendedTopics=!0,!0}catch(t){return this.topicDataState.topicsFetchState=c.U.Failed,this.trackAppError({...p.LQS,message:"Failed fetching recommended topics",pb:{...p.LQS.pb,customMessage:`Failed fetching recommended topics. ${t&&t.message}`}}),!1}}async fetchTopic(t){try{const e=await this.serviceClient.getTopic(t),i=this.topicDataState.topicMap[t];return((0,S.isUndefined)(i)||i.followState!==e.followState)&&(this.topicDataState.topicMap[e.id]=e),!0}catch(e){return this.topicDataState.topicsFetchState=c.U.Failed,this.trackAppError({...p.QGc,message:"Failed to fetch topic.",pb:{...p.QGc.pb,customMessage:`Failed to fetch topic ${t}. ${e&&e.message}`}}),!1}}async fetchTopicGroup(t){if(!t)return!1;const e=this.topicDataState.topicListMap[t],i=(0,S.isUndefined)(e)||e.nextPageUrl;if(!(0,S.isString)(i))return!1;const s=T._3.getParamsFromUrl(i);if(null===s)return!1;try{const e=await this.serviceClient.getTopics(null,s);return this.updateTopicGroup(e.topicGroupMap[t],e.topicMap),!0}catch(e){return this.trackAppError({...p.QGc,message:"Failed to get topics list.",pb:{...p.QGc.pb,customMessage:`Failed to get topics list ${t}. ${e&&e.message}`}}),!1}}async fetchTopics(t){try{const e=await this.serviceClient.getTopics(t);return this.updateTopics(e),this.fetchedAllTopics=!0,!0}catch(t){return this.trackAppError({...p.QGc,message:"Failed fetching topics.",pb:{...p.QGc.pb,customMessage:`Failed fetching topics. ${t&&t.message}`}}),!1}}updateFollowState(){const{followedTopicIds:t,topicMap:e,recommendedTopics:i}=this.topicDataState;Object.keys(e).forEach(i=>{const s=e[i];s&&(s.followState=t.includes(i)?o.$.Followed:o.$.Unfollowed)}),i.forEach(e=>{e.followState=t.includes(e.id)?o.$.Followed:o.$.Unfollowed}),this.reportTopicDataStateChange()}async updateTopicFollowingState(t,e,i,s){try{var n;const a=e===o.$.Followed,r=await this.serviceClient.updateTopicFollowingState(t,a,i);var c;return s?!a||(null==r||null===(c=r.value)||void 0===c?void 0:c.length)&&(null==r?void 0:r.value[0]):(await g.S.purgeCacheAsync(g.p.followedTopics),!t&&a?await this.getFollowedTopics(!0):this.updateTopicFollowedState(null==t?void 0:t.id,e,this.useUserCreatedOrder),!a||(null==r||null===(n=r.value)||void 0===n?void 0:n.length)&&(null==r?void 0:r.value[0]))}catch(i){return void this.trackAppError({...e?p.g07:p.PXf,message:"Failed to update topic followed state.",pb:{...e?p.g07.pb:p.PXf.pb,customMessage:`Failed to update followed state to ${e} for ${null==t?void 0:t.id}. ${i&&i.message}`}})}}updateRecommendedTopics(t){if(!t)return;t=(0,I.A)(t);const e={...this.topicDataState.topicMap};t.forEach(t=>{e[t.id]||(e[t.id]=t)}),this.topicDataState={...this.topicDataState,recommendedTopics:t,topicMap:e,topicsFetchState:c.U.Loaded},this.updateFollowState()}updateTopicGroup(t,e){if(!t||!t.topicIds||0===t.topicIds.length||!e)return;const i={...this.topicDataState.topicListMap},s={...this.topicDataState.topicMap},o=i[t.id];t.nextPageUrl&&(o.nextPageUrl=t.nextPageUrl),o&&o.topicIds&&(o.topicIds=(0,M.A)(o.topicIds,t.topicIds)),t.topicIds.forEach(t=>{s[t]=e[t]}),this.topicDataState={...this.topicDataState,topicListMap:i,topicMap:s,topicsFetchState:c.U.Loaded},this.updateFollowState()}updateTopics(t){if(!t)return;const e={...this.topicDataState.topicMap};Object.keys(t.topicMap).forEach(i=>{const s=this.topicDataState.topicMap[i];e[i]={...t.topicMap[i],isInferred:s&&s.isInferred}}),this.topicDataState={...this.topicDataState,topicListIds:t.topicGroupIds,topicListMap:t.topicGroupMap,topicMap:e,topicsFetchState:c.U.Loaded},this.updateFollowState()}setFollowedTopics(t,e){if(!t)return;const i={...this.topicDataState.topicMap};this.topicDataState={...this.topicDataState,topicMap:i,topicsFetchState:c.U.Loaded};const s=[];Object.keys(t).forEach(e=>{s.push(e);const o=t[e];i[e]=o}),this.topicDataState.followedTopicIds=e?s:(0,M.A)(this.topicDataState.followedTopicIds,s),this.topicDataState.followedTopicNames=this.topicDataState.followedTopicIds.map(t=>{var e;return null===(e=i[t])||void 0===e?void 0:e.name}),this.updateFollowState()}updateTopicFollowedState(t,e,i){const s={...this.topicDataState.topicMap},n=this.topicDataState.followedTopicIds.slice(),c=this.topicDataState.followedTopicNames.slice(),a=this.topicDataState.topicMap[t];if(e!==o.$.Unfollowed){var r,h;if((0,S.isUndefined)(a)){const e={followState:o.$.Followed,id:t,name:""};s[t]=e}else{if(a.followState===o.$.Followed&&!a.isInferred)return;a.followState===o.$.Followed&&a.isInferred&&(s[t].isInferred=!1),s[t].followState=o.$.Followed;this.topicDataState}i?c.unshift(null===(r=s[t])||void 0===r?void 0:r.name):c.push(null===(h=s[t])||void 0===h?void 0:h.name),i?n.unshift(t):n.push(t)}else{if((0,S.isUndefined)(a))return;s[t].followState=o.$.Unfollowed;const e=n.indexOf(t);n.splice(e,1),c.splice(e,1)}const u=this.topicDataState.recommendedTopics.map(i=>({...i,followState:i.id===t?e:i.followState}));this.topicDataState={...this.topicDataState,followedTopicIds:n,followedTopicNames:c,topicMap:s,recommendedTopics:u},this.reportTopicDataStateChange()}reportTopicDataStateChange(){this.stateChangeCallback&&this.topicDataState&&this.stateChangeCallback(this.topicDataState)}async gettingTopicsAfterMigration(){return!(!(0,F.Lg)().getItem("interests-need-refresh")||2!==await(0,k.XK)())&&((0,F.Lg)().removeItem("interests-need-refresh"),!0)}trackAppError(t){b.YT.sendAppErrorEvent({...t})}}const q={experienceConfigSchema:{}}},13969:function(t,e,i){i.d(e,{i:function(){return y}});var s=i(17254),o=i(12870),n=i(16507),c=i(85889),a=i(57759),r=i(74326),h=i(19993),u=i(28868),l=i(64405),p=i(57863),d=i(56639),f=i(65022),w=i(86948),g=i(85490);class y{constructor(t,e){this.fetchImpl=t,this.handleAppErrorEventCall=e,this.endPoint="msn/suggestions",this.serviceOcid="feeds"}async getSuggestedInterests(t,e,i){if(n.n.isNullOrWhiteSpace(t))return[];const s=t.trim(),o=await this.getRequestInit(),c=[...await this.getCommonParams(),{key:"qscope",value:"news"},{key:"q",value:s},{key:"Type",value:i||"provider,bingtopic,category"},{key:"$top",value:String(e)}],a=(0,r.nI)(this.endPoint);return c.forEach(t=>t.value&&a.searchParams.set(t.key,t.value)),await this.fetchSuggestionItems(a,o)}async getSuggestedInterestsAndSources(t,e,i){if(n.n.isNullOrWhiteSpace(t))return[];const s=t.trim(),o=await this.getRequestInit(),c=[...await this.getCommonParams(),{key:"qscope",value:"news"},{key:"q",value:s},{key:"kind",value:(null==i?void 0:i.kind)||"topic"},{key:"subKind",value:(null==i?void 0:i.subKind)||"bingtopic,category"},{key:"$top",value:String(e)}],a=(0,r.nI)(`v1/${this.endPoint}`);return c.forEach(t=>t.value&&a.searchParams.set(t.key,t.value)),await this.fetchSuggestionItems(a,o)}async fetchSuggestionItems(t,e){const i=await this.sendRequest(decodeURIComponent(t.href),e);if(!i)return null;let s=null;try{s=i.value[0].groups[0].suggestionItems}catch(t){this.handleAppErrorEventCall(f.T38)}return(0,g.A)(s,"id")}async getRequestInit(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;null==t&&(t={method:"GET"});const e=(0,o.Th)().CurrentFlights;return(null!=e&&e.includes("1s-r-user-qsp")||2===await(0,w.XK)())&&(t.credentials="include"),t.headers=(0,u.RH)()?await(0,l.U)():await h.WR.getOneServiceHeaders(),t}async getCommonParams(){if("winWidgets"===s.T3.AppType&&(this.serviceOcid="winp2"),(0,u.RH)())return this.getSapphireQueryParams();const t=2===await(0,w.XK)()?h.WR.getOneServiceParamsWithAuth(s.T3.UserId,this.serviceOcid):h.WR.getOneServiceParamsWithoutAuth(s.T3.UserId,this.serviceOcid);if(this.forcedApiKey){t.find(t=>"apikey"==t.key).value=this.forcedApiKey}return t}getSapphireQueryParams(){const t=h.WR.getOneServiceNonDynamicParamsWithoutAuth(this.serviceOcid),e=(0,d.cE)();return e&&(t.push({key:s.T3.OneServiceContentMarketQspKey,value:e.market}),s.T3.ShouldUseFdheadQsp&&t.push({key:"fdhead",value:e.features}),t.push({key:"activityId",value:e.activityId}),e.latitude&&e.longitude&&t.push({key:"location",value:`${e.latitude}|${e.longitude}`})),t}async sendRequest(t,e){return(0,c.Iv)()?await this.sapphireRequest(decodeURIComponent(t),e):await this.networkRequest(decodeURIComponent(t),e)}async sapphireRequest(t,e){const i={url:t,headers:e.headers,body:e.body,refresh:!0},s=await(0,p.XN)(i);return JSON.parse(s||"{}")}async networkRequest(t,e){return await(0,a.w)(async()=>{const i=await this.fetchImpl(t,e);return i.ok?i.json():(this.handleAppErrorEventCall(f._NJ),null)},"getSuggestedInterests")}setForcedApiKey(t){this.forcedApiKey=t}}}}]);