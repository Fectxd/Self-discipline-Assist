# ğŸ¯ æ—¥ç¨‹å±‚çº§ä½“ç³»å®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. æ ¸å¿ƒæ¨¡å‹ (Models)

#### `SchedulePriority` æšä¸¾ (`lib/models/schedule_priority.dart`)
å®šä¹‰äº†å››å±‚ä¼˜å…ˆçº§ä½“ç³»ï¼š
- **Priority 1**: é»˜è®¤æ¯æ—¥æ—¥ç¨‹ï¼ˆæœ€ä½ï¼‰
- **Priority 2**: å·¥ä½œæ—¥/ä¼‘æ¯æ—¥æ¨¡æ¿
- **Priority 3**: å¤§å°å‘¨æ¨¡æ¿
- **Priority 4**: ç‰¹æ®Šæ—¥ç¨‹ï¼ˆæœ€é«˜ï¼‰

#### `TemplateType` æšä¸¾
å®šä¹‰äº†æ¨¡æ¿ç±»å‹ï¼š
- `none` - æ™®é€šæ—¥ç¨‹
- `workday` - å·¥ä½œæ—¥æ¨¡æ¿
- `restday` - ä¼‘æ¯æ—¥æ¨¡æ¿
- `bigWeek` - å¤§å‘¨æ¨¡æ¿
- `smallWeek` - å°å‘¨æ¨¡æ¿

#### `RecurrencePattern` æšä¸¾
å®šä¹‰äº†é‡å¤å‘¨æœŸï¼š
- `none` - ä¸é‡å¤
- `daily` - æ¯å¤©
- `weekly` - æ¯å‘¨
- `biweekly` - æ¯ä¸¤å‘¨
- `monthly` - æ¯æœˆ

#### æ‰©å±•çš„ `Schedule` æ¨¡å‹ (`lib/models/schedule.dart`)
æ–°å¢å­—æ®µï¼š
```dart
SchedulePriority priority;      // ä¼˜å…ˆçº§
TemplateType templateType;       // æ¨¡æ¿ç±»å‹
RecurrencePattern recurrence;    // é‡å¤å‘¨æœŸ
String? sourceTemplateId;        // æºæ¨¡æ¿ID
bool allowOverride;              // æ˜¯å¦å…è®¸è¢«è¦†ç›–
```

#### `ScheduleTemplate` æ¨¡å‹ (`lib/models/schedule_template.dart`)
ç”¨äºå­˜å‚¨å¯é‡ç”¨çš„æ—¥ç¨‹æ¨¡æ¿ï¼š
```dart
String title;
TemplateType templateType;
SchedulePriority priority;
String? startTime;  // "HH:mm"
String? endTime;    // "HH:mm"
int sortOrder;
bool isEnabled;
```

---

### 2. æ•°æ®åº“å‡çº§ (`lib/services/database_service.dart`)

#### æ–°å¢è¡¨ï¼š`schedule_templates`
å­˜å‚¨æ—¥ç¨‹æ¨¡æ¿æ•°æ®

#### æ‰©å±•è¡¨ï¼š`schedules`
æ–°å¢å­—æ®µï¼š
- `priority` - ä¼˜å…ˆçº§ï¼ˆ1-4ï¼‰
- `template_type` - æ¨¡æ¿ç±»å‹
- `recurrence` - é‡å¤å‘¨æœŸ
- `source_template_id` - æºæ¨¡æ¿ID
- `allow_override` - æ˜¯å¦å…è®¸è¢«è¦†ç›–

#### æ•°æ®åº“ç‰ˆæœ¬å‡çº§
- ç‰ˆæœ¬ 1 â†’ ç‰ˆæœ¬ 2
- è‡ªåŠ¨è¿ç§»æ—§æ•°æ®
- æ·»åŠ å¿…è¦çš„ç´¢å¼•

#### æ–°å¢æ–¹æ³•
```dart
// æ¨¡æ¿æ“ä½œ
insertTemplate(ScheduleTemplate)
updateTemplate(ScheduleTemplate)
deleteTemplate(String id)
getTemplatesByType(TemplateType)
getAllTemplates()
updateTemplateSortOrder(List<String>)
```

---

### 3. æ¨¡æ¿æœåŠ¡ (`lib/services/template_service.dart`)

#### æ ¸å¿ƒåŠŸèƒ½

##### æ¨¡æ¿ç®¡ç†
- `saveTemplate()` - ä¿å­˜å•ä¸ªæ¨¡æ¿
- `saveTemplates()` - æ‰¹é‡ä¿å­˜æ¨¡æ¿
- `getTemplates()` - è·å–æŒ‡å®šç±»å‹çš„æ¨¡æ¿
- `deleteTemplate()` - åˆ é™¤æ¨¡æ¿

##### æ—¥ç¨‹ç”Ÿæˆ
- `generateSchedulesForDate()` - ä¸ºæŒ‡å®šæ—¥æœŸç”Ÿæˆæ—¥ç¨‹
  - è‡ªåŠ¨æŒ‰ä¼˜å…ˆçº§åº”ç”¨æ¨¡æ¿
  - ç‰¹æ®Šæ—¥ç¨‹ â†’ å¤§å°å‘¨ â†’ å·¥ä½œæ—¥/ä¼‘æ¯æ—¥

##### æ¨¡æ¿åº”ç”¨
- `applyTemplatesToDate()` - åº”ç”¨æ¨¡æ¿åˆ°æŒ‡å®šæ—¥æœŸ
  - æ ¹æ®ä¼˜å…ˆçº§è¦†ç›–ç°æœ‰æ—¥ç¨‹
- `applyTemplatesToRange()` - æ‰¹é‡åº”ç”¨åˆ°æ—¥æœŸèŒƒå›´

##### è¾…åŠ©æ–¹æ³•
- `getBiweeklyType()` - è·å–å¤§å°å‘¨ç±»å‹
- `isValidTimeFormat()` - éªŒè¯æ—¶é—´æ ¼å¼
- `formatTime()` - æ ¼å¼åŒ–æ—¶é—´

---

### 4. è‡ªç„¶è¯­è¨€å‘½ä»¤è§£æå™¨ (`lib/services/nlp_command_parser.dart`)

#### æ”¯æŒçš„å‘½ä»¤æ ¼å¼

##### 1. åˆ›å»ºæ—¥ç¨‹
```
åˆ›å»º [æ—¥æœŸ] [æ ‡é¢˜] åœ¨ [æ—¶é—´]
```
ç¤ºä¾‹ï¼š
- `åˆ›å»º ä»Šå¤© æ™¨è·‘ åœ¨ 06:00-07:00`
- `åˆ›å»º 2024-11-25 å¼€ä¼š åœ¨ 14:00-15:30 æè¿°:è®¨è®ºé¡¹ç›®è¿›åº¦`

##### 2. ä¿®æ”¹æ—¥ç¨‹
```
ä¿®æ”¹ [æ—¥æœŸ] çš„ [æ ‡é¢˜] ä¸º [æ–°å†…å®¹]
```
ç¤ºä¾‹ï¼š
- `ä¿®æ”¹ ä»Šå¤© çš„ æ™¨è·‘ ä¸º æ™¨è·‘+å†¥æƒ³`
- `ä¿®æ”¹ 2024-11-25 çš„ å¼€ä¼š æ—¶é—´ä¸º 15:00-16:00`

##### 3. åˆ é™¤æ—¥ç¨‹
```
åˆ é™¤ [æ—¥æœŸ] çš„ [æ ‡é¢˜]
```
ç¤ºä¾‹ï¼š
- `åˆ é™¤ ä»Šå¤© çš„ æ™¨è·‘`

##### 4. å®Œæˆæ—¥ç¨‹
```
å®Œæˆ [æ ‡é¢˜]
```
ç¤ºä¾‹ï¼š
- `å®Œæˆ æ™¨è·‘`

##### 5. è®¾ç½®æ¨¡æ¿
```
è®¾ç½®[æ¨¡æ¿ç±»å‹]: [æ—¥ç¨‹åˆ—è¡¨]
```
ç¤ºä¾‹ï¼š
- `è®¾ç½®å·¥ä½œæ—¥æ¨¡æ¿: 06:00-07:00 æ™¨è·‘, 09:00-18:00 å·¥ä½œ, 19:00-20:00 å­¦ä¹ `

##### 6. æŸ¥è¯¢æ—¥ç¨‹
```
æŸ¥è¯¢ [æ—¥æœŸ] çš„æ—¥ç¨‹
```
ç¤ºä¾‹ï¼š
- `æŸ¥è¯¢ ä»Šå¤© çš„æ—¥ç¨‹`

#### å‘½ä»¤è§£æåŠŸèƒ½
- æ—¥æœŸè¯†åˆ«ï¼šä»Šå¤©ã€æ˜å¤©ã€åå¤©ã€yyyy-MM-dd
- æ—¶é—´æå–ï¼šHH:mm-HH:mm
- ä¼˜å…ˆçº§è¯†åˆ«ï¼šç‰¹æ®Šã€é‡è¦ç­‰å…³é”®è¯
- æè¿°æå–ï¼šæ”¯æŒ `æè¿°:xxxxx` æ ¼å¼

---

### 5. æ–‡æ¡£å’Œç¤ºä¾‹

#### `æ—¥ç¨‹å±‚çº§ä½“ç³»ä¸è‡ªç„¶è¯­è¨€è§„èŒƒ.md`
å®Œæ•´çš„ç³»ç»Ÿè®¾è®¡æ–‡æ¡£ï¼ŒåŒ…å«ï¼š
- ä¼˜å…ˆçº§å±‚çº§è¯´æ˜
- è‡ªç„¶è¯­è¨€å‘½ä»¤è§„èŒƒ
- ä½¿ç”¨åœºæ™¯ç¤ºä¾‹
- GPT é›†æˆå»ºè®®
- æ•°æ®ç»“æ„è¯´æ˜

#### `lib/examples/schedule_system_example.dart`
ä»£ç ä½¿ç”¨ç¤ºä¾‹ï¼ŒåŒ…å«ï¼š
- è®¾ç½®å·¥ä½œæ—¥æ¨¡æ¿
- è®¾ç½®å¤§å°å‘¨æ¨¡æ¿
- ä½¿ç”¨è‡ªç„¶è¯­è¨€å‘½ä»¤
- ä¼˜å…ˆçº§è¦†ç›–æ¼”ç¤º
- æ‰¹é‡ç”Ÿæˆæ—¥ç¨‹
- çªå‘æƒ…å†µè°ƒæ•´

---

## ğŸ¨ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç”¨æˆ·ç•Œé¢ (UI Layer)              â”‚
â”‚  - èŠå¤©æ¡†                                â”‚
â”‚  - æ—¥ç¨‹åˆ—è¡¨                              â”‚
â”‚  - æ—¥å†è§†å›¾                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    è‡ªç„¶è¯­è¨€è§£æå™¨ (NLP Layer)            â”‚
â”‚  - å‘½ä»¤è§£æ                              â”‚
â”‚  - å‚æ•°æå–                              â”‚
â”‚  - å‘½ä»¤æ‰§è¡Œ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      æ¨¡æ¿æœåŠ¡ (Template Service)         â”‚
â”‚  - æ¨¡æ¿ç®¡ç†                              â”‚
â”‚  - ä¼˜å…ˆçº§è¦†ç›–                            â”‚
â”‚  - æ—¥ç¨‹ç”Ÿæˆ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æ•°æ®åº“æœåŠ¡ (Database Service)        â”‚
â”‚  - schedules è¡¨                          â”‚
â”‚  - schedule_templates è¡¨                 â”‚
â”‚  - SQLite æœ¬åœ°å­˜å‚¨                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ ä¼˜å…ˆçº§è¦†ç›–é€»è¾‘æµç¨‹

```mermaid
graph TD
    A[æŸ¥è¯¢æŸæ—¥æ—¥ç¨‹] --> B{æ˜¯å¦æœ‰ç‰¹æ®Šæ—¥ç¨‹?}
    B -->|æœ‰| C[è¿”å›ç‰¹æ®Šæ—¥ç¨‹]
    B -->|æ— | D{æ˜¯å¦æœ‰å¤§å°å‘¨æ¨¡æ¿?}
    D -->|æœ‰| E[åº”ç”¨å¤§å°å‘¨æ¨¡æ¿]
    D -->|æ— | F{æ˜¯å·¥ä½œæ—¥è¿˜æ˜¯ä¼‘æ¯æ—¥?}
    F -->|å·¥ä½œæ—¥| G[åº”ç”¨å·¥ä½œæ—¥æ¨¡æ¿]
    F -->|ä¼‘æ¯æ—¥| H[åº”ç”¨ä¼‘æ¯æ—¥æ¨¡æ¿]
    E --> I[è¿”å›ç”Ÿæˆçš„æ—¥ç¨‹]
    G --> I
    H --> I
```

---

## ğŸ“ ä¸‹ä¸€æ­¥é›†æˆ GPT çš„å»ºè®®

### 1. åˆ›å»ºèŠå¤©ç•Œé¢

åœ¨ `lib/screens/` ä¸‹åˆ›å»º `chat_screen.dart`ï¼š
- èŠå¤©æ¶ˆæ¯åˆ—è¡¨
- è¾“å…¥æ¡†
- å‘é€æŒ‰é’®
- å†å²è®°å½•

### 2. é›†æˆ OpenAI API

åˆ›å»º `lib/services/gpt_service.dart`ï¼š
```dart
class GPTService {
  final String apiKey;
  
  Future<String> chat(String userMessage, List<Schedule> schedules) async {
    // 1. æ„å»ºä¸Šä¸‹æ–‡ï¼ˆåŒ…å«å½“å‰æ—¥ç¨‹ï¼‰
    // 2. è°ƒç”¨ OpenAI API
    // 3. è§£æè¿”å›çš„å‘½ä»¤
    // 4. è°ƒç”¨ NLPCommandParser æ‰§è¡Œ
  }
}
```

### 3. ç³»ç»Ÿæç¤ºè¯ (System Prompt)

```
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ—¥ç¨‹ç®¡ç†åŠ©æ‰‹ã€‚ä½ å¯ä»¥å¸®åŠ©ç”¨æˆ·ï¼š
1. åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤æ—¥ç¨‹
2. è®¾ç½®æ—¥ç¨‹æ¨¡æ¿
3. å¤„ç†çªå‘æƒ…å†µï¼Œæ™ºèƒ½è°ƒæ•´æ—¥ç¨‹

ä½ å¿…é¡»ä½¿ç”¨ä»¥ä¸‹æ ‡å‡†å‘½ä»¤æ ¼å¼ï¼š
- åˆ›å»ºæ—¥ç¨‹: åˆ›å»º [æ—¥æœŸ] [æ ‡é¢˜] åœ¨ [æ—¶é—´]
- ä¿®æ”¹æ—¥ç¨‹: ä¿®æ”¹ [æ—¥æœŸ] çš„ [æ ‡é¢˜] ä¸º [æ–°å†…å®¹]
- åˆ é™¤æ—¥ç¨‹: åˆ é™¤ [æ—¥æœŸ] çš„ [æ ‡é¢˜]
- å®Œæˆæ—¥ç¨‹: å®Œæˆ [æ ‡é¢˜]
- è®¾ç½®æ¨¡æ¿: è®¾ç½®[æ¨¡æ¿ç±»å‹]: [æ—¥ç¨‹åˆ—è¡¨]
- æŸ¥è¯¢æ—¥ç¨‹: æŸ¥è¯¢ [æ—¥æœŸ] çš„æ—¥ç¨‹

å½“å‰æ—¥ç¨‹ä¼˜å…ˆçº§ï¼š
- ç‰¹æ®Šæ—¥ç¨‹ï¼ˆPriority 4ï¼‰æœ€é«˜ï¼Œä¸å¯è¦†ç›–
- å¤§å°å‘¨æ¨¡æ¿ï¼ˆPriority 3ï¼‰
- å·¥ä½œæ—¥/ä¼‘æ¯æ—¥æ¨¡æ¿ï¼ˆPriority 2ï¼‰
- é»˜è®¤æ—¥ç¨‹ï¼ˆPriority 1ï¼‰æœ€ä½

å½“ç”¨æˆ·åé¦ˆçªå‘æƒ…å†µæ—¶ï¼Œè¯·ï¼š
1. åˆ†ææ—¶é—´å†²çª
2. é‡æ–°å®‰æ’ä½ä¼˜å…ˆçº§ä»»åŠ¡
3. ä¿ç•™æ ¸å¿ƒä»»åŠ¡
4. ç»™å‡ºè°ƒæ•´å»ºè®®
```

### 4. å¯¹è¯æµç¨‹ç¤ºä¾‹

**ç”¨æˆ·**: ä»Šå¤©ä¸‹åˆ2ç‚¹æœ‰ä¸ªç´§æ€¥ä¼šè®®ï¼Œå¸®æˆ‘è°ƒæ•´ä¸€ä¸‹

**GPT åˆ†æ**:
1. æŸ¥è¯¢ä»Šå¤©çš„æ—¥ç¨‹
2. æ£€æµ‹ 14:00-16:00 çš„å†²çª
3. è¯†åˆ«ä½ä¼˜å…ˆçº§ä»»åŠ¡
4. ç”Ÿæˆè°ƒæ•´æ–¹æ¡ˆ

**GPT æ‰§è¡Œå‘½ä»¤**:
```
åˆ›å»º ä»Šå¤© ç´§æ€¥ä¼šè®® åœ¨ 14:00-16:00
ä¿®æ”¹ ä»Šå¤© çš„ å­¦ä¹  æ—¶é—´ä¸º 16:30-18:00
```

**GPT å›å¤ç”¨æˆ·**:
"å·²ä¸ºæ‚¨å®‰æ’ä»Šå¤©ä¸‹åˆ2ç‚¹çš„ç´§æ€¥ä¼šè®®ï¼Œå¹¶å°†å­¦ä¹ æ—¶é—´è°ƒæ•´åˆ°ä¸‹åˆ4:30-6:00ã€‚"

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. è®¾ç½®å·¥ä½œæ—¥æ¨¡æ¿

```dart
final result = await nlpParser.parseAndExecute(
  'è®¾ç½®å·¥ä½œæ—¥æ¨¡æ¿: 06:00-07:00 æ™¨è·‘, 09:00-18:00 å·¥ä½œ, 19:00-21:00 å­¦ä¹ '
);
```

### 2. åˆ›å»ºç‰¹æ®Šæ—¥ç¨‹

```dart
final result = await nlpParser.parseAndExecute(
  'åˆ›å»º ä»Šå¤© ç´§æ€¥ä¼šè®® åœ¨ 14:00-15:30 æè¿°:å®¢æˆ·éœ€æ±‚è®¨è®º'
);
```

### 3. æŸ¥è¯¢æ—¥ç¨‹

```dart
final result = await nlpParser.parseAndExecute('æŸ¥è¯¢ ä»Šå¤© çš„æ—¥ç¨‹');
print(result);
// è¾“å‡º:
// 2024-11-24 çš„æ—¥ç¨‹:
// â—‹ 06:00 - 07:00 æ™¨è·‘
// â—‹ 09:00 - 18:00 å·¥ä½œ
// â—‹ 14:00 - 15:30 ç´§æ€¥ä¼šè®®
// â—‹ 19:00 - 21:00 å­¦ä¹ 
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `lib/models/schedule_priority.dart` - ä¼˜å…ˆçº§å®šä¹‰
- `lib/models/schedule_template.dart` - æ¨¡æ¿æ¨¡å‹
- `lib/models/schedule.dart` - æ—¥ç¨‹æ¨¡å‹ï¼ˆå·²æ‰©å±•ï¼‰
- `lib/services/database_service.dart` - æ•°æ®åº“æœåŠ¡ï¼ˆå·²å‡çº§ï¼‰
- `lib/services/template_service.dart` - æ¨¡æ¿æœåŠ¡
- `lib/services/nlp_command_parser.dart` - è‡ªç„¶è¯­è¨€è§£æå™¨
- `lib/examples/schedule_system_example.dart` - ä½¿ç”¨ç¤ºä¾‹
- `æ—¥ç¨‹å±‚çº§ä½“ç³»ä¸è‡ªç„¶è¯­è¨€è§„èŒƒ.md` - è®¾è®¡æ–‡æ¡£

---

## âœ¨ ç‰¹æ€§äº®ç‚¹

1. **å››å±‚ä¼˜å…ˆçº§ä½“ç³»** - çµæ´»ä¸”æ¸…æ™°çš„æ—¥ç¨‹è¦†ç›–é€»è¾‘
2. **æ¨¡æ¿å¤ç”¨** - é¿å…é‡å¤åˆ›å»ºç›¸ä¼¼æ—¥ç¨‹
3. **è‡ªç„¶è¯­è¨€å‘½ä»¤** - æ˜“äºäººç±»å’Œ AI ç†è§£
4. **æ™ºèƒ½è¦†ç›–** - é«˜ä¼˜å…ˆçº§è‡ªåŠ¨è¦†ç›–ä½ä¼˜å…ˆçº§
5. **è½»é‡åŒ–** - æœ¬åœ° SQLite å­˜å‚¨ï¼Œè·¨å¹³å°æ”¯æŒ
6. **GPT å‹å¥½** - æ ‡å‡†åŒ–å‘½ä»¤æ ¼å¼ï¼Œä¾¿äºé›†æˆ

---

**å¼€å‘è€…**: è‡ªå¾‹åŠ©æ‰‹å¼€å‘å›¢é˜Ÿ  
**æ—¥æœŸ**: 2024-11-24  
**ç‰ˆæœ¬**: 1.0
