# æ—§ç‰ˆå¤©æ°”å’Œä½ç½®æœåŠ¡å®ç°æ–‡æ¡£

æœ¬æ–‡æ¡£è®°å½•äº†ä¹‹å‰å¤æ‚çš„å¤©æ°”è·å–ã€ä½ç½®å®šä½ã€åŸå¸‚é€‰æ‹©ç­‰åŠŸèƒ½çš„å®ç°æ–¹å¼ï¼Œä¾›å‚è€ƒã€‚

## ç›®å½•
- [æ—§ç‰ˆå¤©æ°”æœåŠ¡](#æ—§ç‰ˆå¤©æ°”æœåŠ¡)
- [æ—§ç‰ˆä½ç½®æœåŠ¡](#æ—§ç‰ˆä½ç½®æœåŠ¡)
- [å®ç°ç»éªŒæ€»ç»“](#å®ç°ç»éªŒæ€»ç»“)

---

## æ—§ç‰ˆå¤©æ°”æœåŠ¡

### æ–‡ä»¶ä½ç½®
`lib/services/weather_service.dart`(å·²åºŸå¼ƒ)
`lib/services/location_service.dart`(å·²åºŸå¼ƒ)

### åŠŸèƒ½ç‰¹ç‚¹

1. **ä¸‰å±‚ç¼“å­˜æœºåˆ¶**
   - å†…å­˜ç¼“å­˜ï¼ˆå¤šåŸå¸‚Mapï¼‰- æœ€å¿«
   - æŒä¹…åŒ–ç¼“å­˜ï¼ˆSharedPreferencesï¼‰- æ¬¡å¿«  
   - APIè¯·æ±‚ï¼ˆèšåˆæ•°æ®APIï¼‰- ä»…åœ¨ç¼“å­˜å¤±æ•ˆæ—¶

2. **èšåˆæ•°æ®API**
   - ä½¿ç”¨èšåˆæ•°æ®çš„å¤©æ°”API
   - éœ€è¦API Keyé…ç½®
   - è¿”å›5å¤©å¤©æ°”é¢„æŠ¥
   - åŒ…å«æ¸©åº¦ã€é£å‘ã€æ¹¿åº¦ç­‰è¯¦ç»†ä¿¡æ¯

3. **ä½ç½®è·å–**
   - ä½¿ç”¨IPå®šä½ï¼ˆcip.ccå…è´¹APIï¼‰
   - 2å°æ—¶ç¼“å­˜é¿å…é¢‘ç¹è¯·æ±‚
   - æ”¯æŒè‡ªåŠ¨å®šä½å’Œæ‰‹åŠ¨é€‰æ‹©åŸå¸‚
   - åŸå¸‚æ•°æ®åº“(assets/cities.json)

### æ ¸å¿ƒä»£ç ç¤ºä¾‹

```dart
/// è·å–å¤©æ°”ä¿¡æ¯ï¼ˆæ™ºèƒ½ç¼“å­˜ç­–ç•¥ï¼‰
Future<Map<String, dynamic>?> getWeather(String city, {bool forceRefresh = false}) async {
  final today = DateTime.now();
  final todayStr = '${today.year}-${today.month.toString().padLeft(2, '0')}-${today.day.toString().padLeft(2, '0')}';

  // æ£€æµ‹åˆ°æ—¥æœŸå˜æ›´ï¼ˆè·¨æ—¥ï¼‰ï¼Œæ¸…é™¤æ‰€æœ‰å†…å­˜ç¼“å­˜
  if (_cacheDate != null && _cacheDate != todayStr) {
    debugPrint('ğŸ”„ æ£€æµ‹åˆ°æ—¥æœŸå˜æ›´: $_cacheDate -> $todayStrï¼Œæ¸…é™¤æ‰€æœ‰å†…å­˜ç¼“å­˜');
    _memoryCache.clear();
    _cacheDate = null;
  }

  // å¦‚æœæœ‰å†…å­˜ç¼“å­˜ä¸”åŸå¸‚ã€æ—¥æœŸéƒ½åŒ¹é…ï¼Œç›´æ¥è¿”å›
  final memoryCached = _memoryCache[city];
  if (!forceRefresh &&
      memoryCached != null &&
      _cacheDate == todayStr &&
      memoryCached['city'] == city &&
      memoryCached['date'] == todayStr) {
    debugPrint('âœ“ ä½¿ç”¨å†…å­˜ç¼“å­˜: $city ($todayStr)');
    _currentCity = city;
    _currentWeather = memoryCached;
    notifyListeners();
    return memoryCached;
  }

  // ... æŒä¹…åŒ–ç¼“å­˜å’ŒAPIè¯·æ±‚é€»è¾‘
}
```

### IPå®šä½å®ç°

```dart
/// ä½¿ç”¨IPå®šä½APIè·å–åŸå¸‚ï¼ˆå…è´¹ï¼Œæ— éœ€keyï¼‰
Future<String?> getCurrentCity({bool useCache = false}) async {
  // å¦‚æœå…³é—­äº†è‡ªåŠ¨å®šä½ï¼Œç›´æ¥è¿”å›æ‰‹åŠ¨è®¾ç½®çš„åŸå¸‚
  if (!_autoLocationEnabled) {
    final city = _manualCity ?? 'åŒ—äº¬';
    debugPrint('ä½¿ç”¨æ‰‹åŠ¨è®¾ç½®çš„åŸå¸‚: $city');
    return city;
  }

  // è·ç¦»ä¸Šæ¬¡è¯·æ±‚ < 2å°æ—¶ï¼Œä½¿ç”¨ç¼“å­˜ï¼ˆé¿å…é¢‘ç¹è°ƒç”¨APIï¼‰
  if (_cachedCity != null && _cityFetchTime != null) {
    final now = DateTime.now();
    final diff = now.difference(_cityFetchTime!);
    if (diff.inMinutes < 120) {
      debugPrint('ä½¿ç”¨2å°æ—¶å†…ç¼“å­˜åŸå¸‚: $_cachedCity (${diff.inMinutes}åˆ†é’Ÿå‰)');
      return _cachedCity;
    }
  }

  try {
    // ä½¿ç”¨ cip.ccï¼ˆå…è´¹ï¼Œæ— éœ€keyï¼Œå›½å†…ç¨³å®šï¼‰
    final response = await httpGet(
      Uri.parse('http://www.cip.cc/'),
      timeout: const Duration(seconds: 5),
    );

    if (response.statusCode == 200) {
      final text = utf8.decode(response.bodyBytes);
      // è§£ææ–‡æœ¬æ ¼å¼ï¼šåœ°å€ : ä¸­å›½ å¹¿ä¸œ æ±•å¤´
      final addressMatch = RegExp(r'åœ°å€\s*:\s*([^\n\r]+)').firstMatch(text);
      if (addressMatch != null) {
        final addressLine = addressMatch.group(1)!.trim();
        // æå–æœ€åä¸€ä¸ªç©ºæ ¼åçš„éƒ¨åˆ†
        final parts = addressLine.split(RegExp(r'\s+'));
        if (parts.isNotEmpty) {
          String cityName = parts.last;
          // å»æ‰æœ«å°¾çš„"å¸‚"å­—
          if (cityName.endsWith('å¸‚')) {
            cityName = cityName.substring(0, cityName.length - 1);
          }
          _cachedCity = cityName;
          _cityFetchTime = DateTime.now();
          return _cachedCity;
        }
      }
    }
  } catch (e) {
    debugPrint('IPå®šä½å¤±è´¥: $e');
  }

  return 'åŒ—äº¬'; // é»˜è®¤åŸå¸‚
}
```

---

## æ—§ç‰ˆä½ç½®æœåŠ¡

### SharedPreferenceså­˜å‚¨é”®

- `location_auto_enabled`: è‡ªåŠ¨å®šä½å¼€å…³ï¼ˆboolï¼Œé»˜è®¤trueï¼‰
- `location_manual_city`: æ‰‹åŠ¨è®¾ç½®çš„åŸå¸‚ï¼ˆStringï¼Œé»˜è®¤"åŒ—äº¬"ï¼‰
- `location_cached_city`: ç¼“å­˜çš„åŸå¸‚ï¼ˆStringï¼Œç”¨äºå¿«é€Ÿå¯åŠ¨ï¼‰

### åŸå¸‚é€‰æ‹©å¯¹è¯æ¡†

åœ¨è®¾ç½®é¡µé¢æä¾›åŸå¸‚é€‰æ‹©å¯¹è¯æ¡†ï¼Œæ”¯æŒï¼š
- æœç´¢åŸå¸‚
- ç›´æ¥è¾“å…¥è‡ªå®šä¹‰åŸå¸‚å
- ä»cities.jsonåŠ è½½åŸå¸‚åˆ—è¡¨

```dart
// æ˜¾ç¤ºåŸå¸‚é€‰æ‹©å¯¹è¯æ¡†
final selectedCity = await showDialog<String>(
  context: context,
  builder: (context) => CitySelectionDialog(
    currentCity: locationService.manualCity,
  ),
);
if (selectedCity != null) {
  await locationService.setManualCity(selectedCity);
  await weatherService.getWeather(selectedCity);
}
```

---

## å®ç°ç»éªŒæ€»ç»“

### 1. ç¼“å­˜ç­–ç•¥

**æ•™è®­**ï¼šä¸è¦è¿‡åº¦ç¼“å­˜ï¼Œä½†ä¹Ÿè¦é¿å…é¢‘ç¹APIè°ƒç”¨

- âœ… å†…å­˜ç¼“å­˜ï¼šç”¨äºåŒä¸€ä¼šè¯å†…å¿«é€Ÿè®¿é—®
- âœ… æŒä¹…åŒ–ç¼“å­˜ï¼šç”¨äºåº”ç”¨é‡å¯åç«‹å³æ˜¾ç¤ºï¼ˆ15åˆ†é’Ÿè¿‡æœŸï¼‰
- âœ… æ—¥æœŸæ£€æŸ¥ï¼šè·¨æ—¥è‡ªåŠ¨æ¸…é™¤ç¼“å­˜
- âŒ ä¸è¦æ— é™æœŸç¼“å­˜å¤©æ°”æ•°æ®
- âŒ ä¸è¦åœ¨UIçº¿ç¨‹åŒæ­¥ç­‰å¾…ç½‘ç»œè¯·æ±‚

### 2. ä½ç½®è·å–

**æ•™è®­**ï¼šIPå®šä½ä¸å¤Ÿç²¾ç¡®ï¼Œä½†å…è´¹ä¸”ç¨³å®š

- âœ… cip.ccåœ¨å›½å†…ç¨³å®šå¯ç”¨
- âœ… 2å°æ—¶ç¼“å­˜å‡å°‘è¯·æ±‚é¢‘ç‡
- âœ… æä¾›æ‰‹åŠ¨é€‰æ‹©åŸå¸‚çš„å¤‡é€‰æ–¹æ¡ˆ
- âŒ VPNä¼šå½±å“IPå®šä½å‡†ç¡®æ€§
- âŒ ä¸è¦ä¾èµ–GPSå®šä½ï¼ˆéœ€è¦æƒé™ä¸”è€—ç”µï¼‰

### 3. å¼‚æ­¥åŠ è½½

**æ•™è®­**ï¼šé¿å…é˜»å¡UI

```dart
// âŒ é”™è¯¯ï¼šåŒæ­¥ç­‰å¾…å¤©æ°”
await weatherService.getWeather(city);
setState(() {}); // UIè¢«é˜»å¡

// âœ… æ­£ç¡®ï¼šå¼‚æ­¥åå°åŠ è½½
weatherService.getWeather(city); // ç«‹å³è¿”å›
// UIä¸é˜»å¡ï¼Œæ•°æ®åˆ°è¾¾åé€šè¿‡notifyListeners()æ›´æ–°
```

### 4. é”™è¯¯å¤„ç†

**æ•™è®­**ï¼šç½‘ç»œè¯·æ±‚å¿…é¡»æœ‰é™çº§ç­–ç•¥

- âœ… APIå¤±è´¥æ—¶ä½¿ç”¨æ—§ç¼“å­˜
- âœ… è¶…æ—¶è®¾ç½®ï¼ˆ10-15ç§’ï¼‰
- âœ… æ˜¾ç¤ºåŠ è½½çŠ¶æ€å’Œé”™è¯¯æç¤º
- âŒ ä¸è¦è®©ä¸€ä¸ªAPIå¤±è´¥å¯¼è‡´æ•´ä¸ªé¡µé¢å´©æºƒ

### 5. Provideræ¨¡å¼

**æ•™è®­**ï¼šåˆç†ä½¿ç”¨ChangeNotifier

```dart
// âœ… æ­£ç¡®ï¼šä½¿ç”¨Consumerè‡ªåŠ¨æ›´æ–°UI
Consumer<WeatherService>(
  builder: (context, weatherService, child) {
    if (weatherService.currentWeather != null) {
      return WeatherCard(data: weatherService.currentWeather);
    }
    return LoadingIndicator();
  },
)

// âŒ é”™è¯¯ï¼šæ‰‹åŠ¨setState
final weather = await weatherService.getWeather(city);
setState(() {
  _weather = weather; // ä¸å¿…è¦çš„çŠ¶æ€ç®¡ç†
});
```

---

## ä¸ºä»€ä¹ˆè¦é‡æ„ï¼Ÿ

### æ—§ç‰ˆé—®é¢˜

1. **å¤æ‚åº¦é«˜**
   - å¤šä¸ªæœåŠ¡ç›¸äº’ä¾èµ–ï¼ˆLocationService + WeatherServiceï¼‰
   - éœ€è¦API Keyé…ç½®
   - åŸå¸‚æ•°æ®åº“éœ€è¦ç»´æŠ¤

2. **ç”¨æˆ·ä½“éªŒå·®**
   - IPå®šä½ä¸ç²¾ç¡®
   - éœ€è¦æ‰‹åŠ¨é…ç½®åŸå¸‚
   - å¤©æ°”æ•°æ®æœ‰æ—¶å»¶è¿Ÿ

3. **ç»´æŠ¤æˆæœ¬é«˜**
   - APIå¯èƒ½å¤±æ•ˆéœ€è¦æ›´æ¢
   - åŸå¸‚æ•°æ®åº“éœ€è¦æ›´æ–°
   - ç¼“å­˜é€»è¾‘å¤æ‚æ˜“å‡ºbug

### æ–°ç‰ˆä¼˜åŠ¿ï¼ˆMSN APIï¼‰

1. **ç®€å•ç›´æ¥**
   - å•ä¸ªAPIè·å–æ‰€æœ‰æ•°æ®
   - æ— éœ€API Key
   - è‡ªåŠ¨å®šä½ï¼ˆåŸºäºMSNï¼‰

2. **æ•°æ®ä¸°å¯Œ**
   - å¤©æ°” + æ—¥å† + å†œå† + å®œå¿Œ
   - å®æ—¶æ›´æ–°
   - 5å¤©é¢„æŠ¥

3. **æ˜“äºç»´æŠ¤**
   - åªä¾èµ–MSN API
   - 15åˆ†é’Ÿç¼“å­˜æœºåˆ¶ç®€å•
   - ä¸€æ¬¡è¯·æ±‚è·å–æ‰€æœ‰ä¿¡æ¯

---

## å‚è€ƒæ–‡ä»¶

æ—§ç‰ˆå®ç°çš„å®Œæ•´ä»£ç å·²ä¿å­˜åœ¨gitå†å²ä¸­ï¼š
- `lib/services/weather_service.dart`ï¼ˆæäº¤ï¼šé‡æ„å‰ï¼‰
- `lib/services/location_service.dart`ï¼ˆæäº¤ï¼šé‡æ„å‰ï¼‰
- `lib/widgets/city_selection_dialog.dart`
- `assets/cities.json`

å¯ä»¥é€šè¿‡gitæŸ¥çœ‹å…·ä½“å®ç°ï¼š
```bash
git log --all --full-history -- "lib/services/weather_service.dart"
git show <commit_hash>:lib/services/weather_service.dart
```

---

**é‡æ„å®Œæˆæ—¶é—´**: 2025-12-18
**åŸä½œè€…**: GitHub Copilot
