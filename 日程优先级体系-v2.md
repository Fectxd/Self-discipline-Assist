# 日程层级体系说明 v2.0

## 优先级体系（8级）

**原则：覆盖范围越广，优先级越低**

| 级别 | 名称 | ConditionType | Priority值 | 覆盖范围 | 颜色 | 示例 |
|------|------|---------------|-----------|---------|------|------|
| 1 | 每天 | daily | 1 | 所有日期 | 灰色 | 每天6点起床 |
| 2 | 休息日 | restday | 2 | 周末+节假日 | 浅蓝 | 休息日睡懒觉 |
| 3 | 工作日 | workday | 3 | 工作日 | 绿色 | 工作日晨练 |
| 4 | 每隔N天 | interval | 4 | 特定间隔 | 青色 | 每隔3天吃药 |
| 5 | 周末 | weekend | 5 | 仅周六日 | 粉色 | 周末去健身房 |
| 6 | 节假日 | holiday | 6 | 仅节假日 | 红色 | 节假日出游 |
| 7 | 周X | weekday | 7 | 特定星期几 | 橙色 | 每周一开会 |
| 8 | 特定日期 | specificDate | 8 | 单个日期 | 紫色 | 2025-12-25圣诞聚餐 |

## 覆盖关系

- **节假日** > **周末** > **休息日**
  - 休息日 = 周末 ∪ 节假日
  - 如果某天既是周末又是节假日，节假日规则优先
  
- **特定日期** > **周X** > **节假日/周末** > **每隔N天** > **工作日/休息日** > **每天**

## GPT适配

### 创建日程时的优先级推断

GPT会根据用户输入自动推断优先级：

```javascript
// 用户说："每天6点起床"
{
  recurrence: "daily",
  priority: 1  // 自动推断为每天
}

// 用户说："休息日睡懒觉" 
{
  template_type: "restday",
  priority: 2  // 休息日（周末+节假日）
}

// 用户说："工作日晨练"
{
  template_type: "workday", 
  priority: 3  // 工作日
}

// 用户说："每隔3天吃药"
{
  recurrence: "interval",
  interval_days: 3,
  start_date: "2025-11-24",
  priority: 4
}

// 用户说："周末去健身房"
{
  template_type: "weekend",
  priority: 5  // 仅周六日
}

// 用户说："节假日出游"
{
  template_type: "holiday",
  priority: 6  // 仅节假日
}

// 用户说："每周一开会"
{
  recurrence: "weekly",
  weekday: 1,
  priority: 7
}

// 用户说："明天8点面试"
{
  date: "2025-11-25",
  priority: 8  // 特定日期
}
```

### template_type 枚举

- `none` - 普通日程
- `workday` - 工作日
- `restday` - 休息日（周末+节假日）
- `weekend` - 仅周末（周六日）
- `holiday` - 仅节假日

### recurrence 枚举

- `none` - 不重复
- `daily` - 每天
- `weekly` - 每周某天（需配合weekday）
- `interval` - 每隔N天（需配合interval_days和start_date）
- `monthly` - 每月（暂未实现）

## 数据库层

### schedule_rules 表

```sql
CREATE TABLE schedule_rules (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT,
  time TEXT,                -- HH:mm
  priority INTEGER NOT NULL, -- 1-8
  condition TEXT NOT NULL,   -- JSON: {type, weekday?, specificDate?, intervalDays?, startDate?}
  created_at TEXT NOT NULL,
  updated_at TEXT NOT NULL,
  is_enabled INTEGER DEFAULT 1
);
```

### RuleCondition 判断逻辑

```dart
bool appliesTo(DateTime date, {required bool isWorkday, required bool isHoliday}) {
  final isWeekend = date.weekday >= 6;
  
  switch (condition.type) {
    case ConditionType.daily:
      return true;  // 所有日期
      
    case ConditionType.restday:
      return isWeekend || isHoliday;  // 周末或节假日
      
    case ConditionType.workday:
      return isWorkday;  // 工作日（非周末且非节假日）
      
    case ConditionType.interval:
      return (date - startDate).inDays % intervalDays == 0;
      
    case ConditionType.weekend:
      return isWeekend;  // 仅周六日
      
    case ConditionType.holiday:
      return isHoliday;  // 仅节假日
      
    case ConditionType.weekday:
      return date.weekday == condition.weekday;
      
    case ConditionType.specificDate:
      return date == condition.specificDate;
  }
}
```

## UI显示

### 标签文本

- 每天 → "每天"
- 休息日 → "休息日"  
- 工作日 → "工作日"
- 每隔N天 → "每3天"（动态显示间隔数）
- 周末 → "周末"
- 节假日 → "节假日"
- 周X → "周一"/"周二"/.../"周日"
- 特定日期 → "单次"

### 标签颜色

- 灰色：每天
- 浅蓝：休息日
- 绿色：工作日
- 青色：每隔N天
- 粉色：周末
- 红色：节假日
- 橙色：周X
- 紫色：特定日期

## 冲突检测

GPT会在创建日程前检查5类冲突：

1. **时间冲突** - 同一时间段有其他日程
2. **逻辑冲突** - 相同标题的日程重复
3. **健康冲突** - 睡眠时间不足8小时
4. **过载冲突** - 单日日程过多（>10个）
5. **缓冲冲突** - 日程间隔太近（<15分钟）

## 临时覆盖

通过 `schedule_overrides` 表实现单日修改：

```dart
// 用户："明天11点起"（不影响规则）
{
  action_type: "modify_once",
  schedule_data: {
    title: "起床",
    date: "2025-11-25", 
    new_time: "11:00"
  }
}
```

覆盖类型：
- `skip` - 跳过某天的规则
- `modifyTime` - 修改某天的时间
- `replace` - 完全替换某天的内容
