# 日程层级体系与自然语言规范

## 📋 日程优先级层级（Priority System）

系统采用四层优先级体系，高优先级可以覆盖低优先级的日程：

```
特殊日程 (Priority 4) ← 最高优先级，不可被覆盖
    ↓ 可覆盖
大小周模板 (Priority 3) ← 双周循环模板
    ↓ 可覆盖  
工作日/休息日模板 (Priority 2) ← 根据日期类型自动应用
    ↓ 可覆盖
默认每日日程 (Priority 1) ← 最低优先级，可被任何模板覆盖
```

### 优先级说明

1. **特殊日程 (Special)**
   - 用于重要事件、突发情况
   - 不会被任何模板覆盖
   - 示例：医院预约、重要会议、临时紧急事项

2. **大小周模板 (Biweekly Template)**
   - 用于双周轮换的工作制
   - 大周（第1、3、5周...）和小周（第2、4、6周...）
   - 可覆盖工作日/休息日模板

3. **工作日/休息日模板 (Weekday Template)**
   - 根据日期类型自动应用
   - 工作日、周末、节假日分别设置
   - 可覆盖普通日程

4. **默认每日日程 (Daily)**
   - 普通日程
   - 优先级最低，可被任何模板覆盖

---

## 🗣️ 自然语言命令规范（NLP Commands）

为了确保 GPT 能够精准操控日程，设计了以下标准化命令格式：

### 1. 创建日程

**格式：**
```
创建 [日期] [标题] 在 [时间]
```

**参数说明：**
- `[日期]`: 今天 | 明天 | 后天 | yyyy-MM-dd
- `[时间]`: HH:mm-HH:mm（可选）
- 可选添加 `描述:xxxx`

**示例：**
```
创建 今天 晨跑 在 06:00-07:00
创建 明天 团队会议 在 14:00-15:30 描述:讨论Q4目标
创建 2024-11-25 年度体检
```

---

### 2. 修改日程

**格式：**
```
修改 [日期] 的 [标题] 为 [新内容]
```

**示例：**
```
修改 今天 的 晨跑 为 晨跑+冥想
修改 2024-11-25 的 会议 时间为 15:00-16:00
修改 明天 的 学习 描述为:复习算法
```

---

### 3. 删除日程

**格式：**
```
删除 [日期] 的 [标题]
```

**示例：**
```
删除 今天 的 晨跑
删除 2024-11-25 的 会议
```

---

### 4. 完成日程

**格式：**
```
完成 [标题]
```

**示例：**
```
完成 晨跑
完成 团队会议
```

---

### 5. 设置模板

**格式：**
```
设置[模板类型]: [日程列表]
```

**模板类型：**
- `工作日模板` - 周一至周五的日程
- `休息日模板` - 周末和节假日的日程
- `大周模板` - 双周制的第一周
- `小周模板` - 双周制的第二周

**日程列表格式：**
```
HH:mm-HH:mm 标题, HH:mm-HH:mm 标题, ...
```

**示例：**
```
设置工作日模板: 06:00-07:00 晨跑, 09:00-18:00 工作, 19:00-20:00 学习, 21:00-22:00 阅读

设置休息日模板: 08:00-09:00 晨练, 10:00-12:00 个人项目, 15:00-17:00 运动

设置大周模板: 06:30-07:30 晨跑, 09:00-19:00 工作(加班), 20:00-21:00 学习

设置小周模板: 07:00-08:00 晨练, 09:00-18:00 工作, 19:00-21:00 休闲
```

---

### 6. 查询日程

**格式：**
```
查询 [日期] 的日程
```

**示例：**
```
查询 今天 的日程
查询 2024-11-25 的日程
查询 明天 的日程
```

---

## 🔄 模板应用逻辑

### 自动应用规则

当查询某一天的日程时，系统会按照以下优先级顺序应用模板：

1. **检查特殊日程**
   - 如果有特殊日程，直接返回（不应用任何模板）

2. **检查大小周模板**
   - 判断当前日期属于大周还是小周
   - 如果有对应的模板，应用大小周模板

3. **检查工作日/休息日模板**
   - 如果没有大小周模板，根据日期类型应用
   - 工作日 → 工作日模板
   - 周末/节假日 → 休息日模板

4. **返回普通日程**
   - 如果没有任何模板，返回用户手动创建的日程

### 覆盖规则

- 高优先级的日程会覆盖低优先级的日程
- 用户手动创建的日程默认为"默认每日日程"（Priority 1）
- 如果不希望某个日程被模板覆盖，可以设置为"特殊日程"

---

## 💡 使用场景示例

### 场景1：设置工作日常规模板

```
设置工作日模板: 06:00-07:00 晨跑, 08:00-09:00 早餐+通勤, 09:00-12:00 上午工作, 12:00-13:00 午餐, 13:00-18:00 下午工作, 18:00-19:00 晚餐, 19:00-21:00 学习, 21:00-22:00 阅读, 22:00-23:00 休息
```

### 场景2：临时调整

用户今天有紧急会议需要调整：

```
创建 今天 紧急会议 在 10:00-11:30 描述:客户需求讨论
```

这会创建一个特殊日程（Priority 4），不会被模板覆盖。

### 场景3：大小周工作制

```
设置大周模板: 06:30-07:30 晨跑, 09:00-19:00 工作, 20:00-21:00 学习

设置小周模板: 07:00-08:00 晨练, 09:00-18:00 工作, 19:00-21:00 休闲
```

### 场景4：突发情况灵活调整

GPT 可以根据用户反馈进行智能调整：

**用户**: 今天下午突然有个重要会议，帮我重新安排
**GPT 执行**:
```
创建 今天 重要会议 在 14:00-16:00
修改 今天 的 学习 时间为 16:30-18:00
```

---

## 🤖 GPT 集成建议

### 命令生成规范

GPT 应该：
1. 严格遵循命令格式
2. 使用明确的日期（避免模糊表达）
3. 时间格式统一使用 HH:mm
4. 标题简洁明了（3-10个字）

### 智能调整策略

当用户反馈突发情况时，GPT 应该：
1. 分析冲突的日程
2. 根据优先级重新排序
3. 合理压缩或移动低优先级任务
4. 保留核心任务（高优先级）

### 示例对话

**用户**: 今天下午临时有个医院预约，2点到4点，帮我调整一下日程

**GPT 思考**:
- 检查今天下午的日程
- 医院预约是特殊日程（高优先级）
- 需要移动或删除冲突的低优先级任务

**GPT 执行**:
```
创建 今天 医院预约 在 14:00-16:00
删除 今天 的 下午工作
创建 今天 工作 在 16:30-18:30
```

**GPT 回复**: 
"已为您安排今天下午2点的医院预约，并将工作时间调整到下午4:30-6:30。"

---

## 📊 数据结构

### Schedule 模型

```dart
class Schedule {
  String id;
  String title;
  String? description;
  DateTime date;
  DateTime? startTime;
  DateTime? endTime;
  bool isCompleted;
  SchedulePriority priority;  // 1-4
  TemplateType templateType;  // none/workday/restday/bigWeek/smallWeek
  RecurrencePattern recurrence;  // none/daily/weekly/biweekly/monthly
  String? sourceTemplateId;
  bool allowOverride;  // 是否允许被模板覆盖
}
```

### ScheduleTemplate 模型

```dart
class ScheduleTemplate {
  String id;
  String title;
  String? description;
  TemplateType templateType;
  SchedulePriority priority;
  String? startTime;  // "HH:mm"
  String? endTime;    // "HH:mm"
  int sortOrder;
  bool isEnabled;
}
```

---

## ✅ 下一步计划

1. **集成 GPT API**
   - 创建聊天界面
   - 连接 OpenAI API
   - 实现命令解析和执行

2. **智能调整算法**
   - 日程冲突检测
   - 智能时间分配
   - 优先级自动调整

3. **数据同步**
   - 云端备份
   - 多设备同步

4. **通知提醒**
   - 本地推送通知
   - 智能提醒时间

---

**Created by**: 自律助手开发团队  
**Date**: 2024-11-24  
**Version**: 1.0
