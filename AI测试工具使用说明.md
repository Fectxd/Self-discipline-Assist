# AI 错误收集器使用指南

## 🎯 目的

自动化测试 AI 日程助手，收集常见错误案例（缺失 end_time、非法 action_type 等），用于优化 prompt。

## 📦 安装依赖

```bash
pip install -r requirements.txt
```

或者直接安装：
```bash
pip install requests
```

## 🚀 运行测试

```bash
python test_ai_errors.py
```

## 📊 输出报告

测试完成后会生成两个报告文件：

1. **JSON 报告** (`error_report_YYYYMMDD_HHMMSS.json`)
   - 供程序分析使用
   - 包含完整的错误案例数据

2. **Markdown 报告** (`error_report_YYYYMMDD_HHMMSS.md`)
   - 供人类阅读
   - 包含统计摘要和分类错误案例

## 📋 测试用例说明

脚本包含 30+ 个测试用例，覆盖：

### 1. 运动类（需要 end_time）
- "每天早上7点跑步"
- "每周三晚上8点健身"
- "工作日早上6点半锻炼"

### 2. 工作类（需要 end_time）
- "每周一早上9点开周会"
- "工作日晚上7点加班"

### 3. 学习类（需要 end_time）
- "每天晚上8点学习"
- "工作日早上6点看书"

### 4. 生活类（需要 end_time）
- "每天晚上11点睡觉"
- "工作日中午12点吃午饭"

### 5. 瞬时事件（不需要 end_time）
- "每天早上8点吃药"
- "工作日早上7点起床"

### 6. 边界测试
- "早中晚三餐"（应拆分成3条）
- "每天上午下午各运动一次"（应拆分成2条）

### 7. 复杂场景
- "每周一三五跑步"（可能需要创建3条规则）
- "除了周末每天学习"（应该用 workday）

## 🔍 检测的错误类型

1. **缺失 end_time**: 持续性活动（运动、会议、学习等）未提供结束时间
2. **非法 action_type**: 使用了除 create/modify/modify_once/delete 之外的操作类型
3. **时间格式错误**: time/end_time 格式不是 HH:mm
4. **缺失必填字段**: title、time 等必填字段缺失
5. **其他错误**: 其他违反规则的情况

## 📈 示例输出

### 控制台输出

```
============================================================
测试输入: 每天早上7点跑步
============================================================
✓ AI 调用了 1 个函数
  - propose_action
    action_type: create
    title: 晨跑
    time: 07:00
    end_time: 08:00
    ✅ 验证通过
```

### 统计摘要

```
============================================================
测试摘要
============================================================
总测试数: 30
总错误数: 12
错误率: 40.0%

错误类型分布:
  - 缺失 end_time: 8
  - 非法 action_type: 2
  - 时间格式错误: 1
  - 缺失必填字段: 1
  - 其他错误: 0
============================================================
```

## 🎨 自定义测试用例

编辑 `test_ai_errors.py` 中的 `TEST_CASES` 列表：

```python
TEST_CASES = [
    "你的测试用例1",
    "你的测试用例2",
    # ... 添加更多
]
```

## 🔧 配置说明

如需修改 API 配置，编辑脚本顶部的常量：

```python
API_ENDPOINT = "https://chatapi.onechats.ai/v1/chat/completions"
API_KEY = "你的密钥"
MODEL = "gpt-5-nano"
```

## 💡 使用建议

1. **运行前**: 确保 System Prompt 和 Tools 定义与 Flutter 代码一致
2. **运行后**: 查看 Markdown 报告，分析错误模式
3. **优化**: 根据错误案例调整 prompt，然后重新测试
4. **迭代**: 重复运行，直到错误率降到可接受水平

## 📌 注意事项

- 每个测试用例之间有 0.5 秒延迟，避免 API 限流
- 每个测试用例独立运行（不共享对话历史）
- 报告文件包含时间戳，不会覆盖旧报告

## 🐛 故障排除

### API 调用失败
检查：
- API 密钥是否正确
- 网络连接是否正常
- API 额度是否充足

### 没有检测到错误
可能原因：
- AI 表现良好（这是好事！）
- 检测规则需要调整
- 测试用例覆盖不全

---

**祝测试顺利！** 🚀
