# æ—¥ç¨‹ç³»ç»Ÿæ¶æ„è¯´æ˜

> æœ€åæ›´æ–°ï¼š2025-12-01  
> ç³»ç»Ÿç‰ˆæœ¬ï¼šæ•°æ®åº“ v7

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [æ ¸å¿ƒæ¶æ„](#æ ¸å¿ƒæ¶æ„)
- [æ•°æ®æ¨¡å‹](#æ•°æ®æ¨¡å‹)
- [è¯»å†™æµç¨‹](#è¯»å†™æµç¨‹)
- [AI é›†æˆ](#ai-é›†æˆ)
- [UI äº¤äº’](#ui-äº¤äº’)

---

## ç³»ç»Ÿæ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº**è§„åˆ™ï¼ˆRuleï¼‰** + **è¦†ç›–ï¼ˆOverrideï¼‰**çš„çµæ´»æ—¥ç¨‹ç®¡ç†ç³»ç»Ÿã€‚

### æ ¸å¿ƒç†å¿µ

```
è§„åˆ™ï¼ˆScheduleRuleï¼‰ï¼šå®šä¹‰é‡å¤æ€§æ—¥ç¨‹æ¨¡æ¿
    â†“
æ¯æ—¥ç”Ÿæˆï¼ˆGenerate Dailyï¼‰ï¼šæ ¹æ®è§„åˆ™åŠ¨æ€ç”Ÿæˆå½“å¤©æ—¥ç¨‹
    â†“
è¦†ç›–ï¼ˆScheduleOverrideï¼‰ï¼šä¸´æ—¶ä¿®æ”¹æŸå¤©çš„æ—¥ç¨‹
    â†“
æœ€ç»ˆæ—¥ç¨‹ï¼ˆScheduleï¼‰ï¼šç”¨æˆ·çœ‹åˆ°çš„æœ€ç»ˆç»“æœ
```

### å…³é”®ç‰¹æ€§

- âœ… **è§„åˆ™é©±åŠ¨**ï¼šä¸€æ¬¡å®šä¹‰ï¼Œè‡ªåŠ¨ç”Ÿæˆ
- âœ… **çµæ´»è¦†ç›–**ï¼šå•æ—¥ä¿®æ”¹ä¸å½±å“è§„åˆ™
- âœ… **AI èµ‹èƒ½**ï¼šè‡ªç„¶è¯­è¨€æ“ä½œ
- âœ… **é›¶å†—ä½™**ï¼šä¸å­˜å‚¨å†—ä½™æ•°æ®
- âœ… **é«˜æ€§èƒ½**ï¼šO(1) æŸ¥è¯¢å¤æ‚åº¦

---

## æ ¸å¿ƒæ¶æ„

### ä¸‰å±‚æ•°æ®ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. è§„åˆ™å±‚ (schedule_rules)         â”‚  æŒä¹…åŒ–å­˜å‚¨
â”‚     - å®šä¹‰é‡å¤æ€§è§„åˆ™                 â”‚
â”‚     - 8 ç§æ¡ä»¶ç±»å‹                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. è¦†ç›–å±‚ (schedule_overrides)     â”‚  ä¸´æ—¶ä¿®æ”¹
â”‚     - å•æ—¥æˆ–åŒºé—´è¦†ç›–                 â”‚
â”‚     - 5 ç§è¦†ç›–ç±»å‹                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. è§†å›¾å±‚ (åŠ¨æ€ç”Ÿæˆï¼Œä¸å­˜å‚¨)        â”‚  å®æ—¶è®¡ç®—
â”‚     - Schedule å¯¹è±¡                  â”‚
â”‚     - è§„åˆ™ + è¦†ç›– = æœ€ç»ˆæ—¥ç¨‹         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®åº“è¡¨ç»“æ„

| è¡¨å | ç”¨é€” | ç¤ºä¾‹ |
|------|------|------|
| `schedule_rules` | å­˜å‚¨é‡å¤æ€§è§„åˆ™ | "æ¯å¤© 9:00 æ™¨è·‘" |
| `schedule_overrides` | å­˜å‚¨ä¸´æ—¶è¦†ç›– | "ä»Šå¤©æ”¹ 10:00" |
| `day_overrides` | å­˜å‚¨æ—¥æœŸç±»å‹è¦†ç›– | "å‘¨å…­å½“å·¥ä½œæ—¥" |
| `holidays` | å­˜å‚¨èŠ‚å‡æ—¥ | "2025-01-01 å…ƒæ—¦" |
| ~~`schedules`~~ | ~~å·²åºŸå¼ƒ~~ | ~~ä¸å†ä½¿ç”¨~~ |

---

## æ•°æ®æ¨¡å‹

### 1ï¸âƒ£ ScheduleRuleï¼ˆæ—¥ç¨‹è§„åˆ™ï¼‰

**ä½œç”¨**ï¼šå®šä¹‰é‡å¤æ€§æ—¥ç¨‹çš„æ¨¡æ¿

```dart
class ScheduleRule {
  String id;              // å”¯ä¸€æ ‡è¯†
  String title;           // æ ‡é¢˜
  String? description;    // æè¿°
  String? time;           // å¼€å§‹æ—¶é—´ "HH:mm"
  String? endTime;        // ç»“æŸæ—¶é—´ "HH:mm"
  RuleCondition condition; // è§¦å‘æ¡ä»¶
  bool isEnabled;         // æ˜¯å¦å¯ç”¨
  DateTime createdAt;     // åˆ›å»ºæ—¶é—´
}
```

**RuleConditionï¼ˆè§„åˆ™æ¡ä»¶ï¼‰**

| ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| `daily` | æ¯å¤© | æ¯å¤© 9:00 æ™¨è·‘ |
| `workday` | å·¥ä½œæ—¥ | å·¥ä½œæ—¥ 8:30 ä¸Šç­ |
| `restday` | ä¼‘æ¯æ—¥ | ä¼‘æ¯æ—¥ 10:00 ç¡æ‡’è§‰ |
| `weekend` | å‘¨æœ« | å‘¨æœ« 14:00 ç”µå½± |
| `holiday` | èŠ‚å‡æ—¥ | èŠ‚å‡æ—¥ å…¨å¤©ä¼‘æ¯ |
| `weekday` | ç‰¹å®šæ˜ŸæœŸ | æ¯å‘¨ä¸‰ 19:00 å¼€ä¼š |
| `interval` | é—´éš”å¤©æ•° | æ¯ 3 å¤©ä¸€æ¬¡ |
| `specific_date` | ç‰¹å®šæ—¥æœŸ | 2025-01-01 å…ƒæ—¦ |

**æ•°æ®åº“å­—æ®µ**

```sql
CREATE TABLE schedule_rules (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,
  description TEXT,
  time TEXT,
  end_time TEXT,
  condition_type TEXT NOT NULL,  -- æ¡ä»¶ç±»å‹
  condition_data TEXT,           -- æ¡ä»¶æ•°æ®ï¼ˆJSONï¼‰
  is_enabled INTEGER DEFAULT 1,
  created_at TEXT NOT NULL
);
```

### 2ï¸âƒ£ ScheduleOverrideï¼ˆæ—¥ç¨‹è¦†ç›–ï¼‰

**ä½œç”¨**ï¼šä¸´æ—¶ä¿®æ”¹æŸå¤©æˆ–æŸæ®µæ—¶é—´çš„æ—¥ç¨‹

```dart
class ScheduleOverride {
  String id;
  DateTime startDate;      // å¼€å§‹æ—¥æœŸ
  DateTime endDate;        // ç»“æŸæ—¥æœŸï¼ˆå•æ—¥è¦†ç›–æ—¶ç­‰äº startDateï¼‰
  String? ruleId;          // å…³è”çš„è§„åˆ™ID
  OverrideType type;       // è¦†ç›–ç±»å‹
  String? newTime;         // æ–°æ—¶é—´
  String? newEndTime;      // æ–°ç»“æŸæ—¶é—´
  String? newTitle;        // æ–°æ ‡é¢˜
  String? newDescription;  // æ–°æè¿°
  Map<String, dynamic>? metadata; // å…ƒæ•°æ®
  DateTime createdAt;
}
```

**OverrideTypeï¼ˆè¦†ç›–ç±»å‹ï¼‰**

| ç±»å‹ | è¯´æ˜ | endDate | ç¤ºä¾‹ |
|------|------|---------|------|
| `skip` | è·³è¿‡ï¼ˆåˆ é™¤ï¼‰ | =startDate/èŒƒå›´ | ä»Šå¤©å–æ¶ˆæ™¨è·‘ |
| `modifyTime` | ä»…ä¿®æ”¹æ—¶é—´ | =startDate/èŒƒå›´ | ä»Šå¤©æ”¹ 10:00 |
| `modify` | ä¿®æ”¹å¤šä¸ªå±æ€§ | =startDate/èŒƒå›´ | æ”¹æ—¶é—´+æè¿° |
| `replace` | å®Œå…¨æ›¿æ¢ | =startDate/èŒƒå›´ | æ›¿æ¢æˆæ–°å†…å®¹ |
| `complete` | æ ‡è®°å®Œæˆ | **=startDate** | ä»Šå¤©å·²å®Œæˆ âœ… |

**âš ï¸ é‡è¦è§„åˆ™**

- **å•æ—¥è¦†ç›–**ï¼šä»£ç è‡ªåŠ¨åˆ›å»ºçš„ overrideï¼ˆæ‰“å‹¾ã€AIã€ç¼–è¾‘ã€åˆ é™¤ï¼‰éƒ½æ˜¯ `endDate = startDate`
- **èŒƒå›´è¦†ç›–**ï¼šåªæœ‰ç”¨æˆ·åœ¨ UI æ‰‹åŠ¨ç¼–è¾‘æ—¶å¯ä»¥è®¾ç½® `endDate > startDate`
- **complete ç±»å‹**ï¼šæ°¸è¿œæ˜¯å•æ—¥ï¼Œ`endDate = startDate`

**æ•°æ®åº“å­—æ®µ**

```sql
CREATE TABLE schedule_overrides (
  id TEXT PRIMARY KEY,
  start_date TEXT NOT NULL,      -- å¼€å§‹æ—¥æœŸ
  end_date TEXT NOT NULL,        -- ç»“æŸæ—¥æœŸï¼ˆv8+ï¼šå¿…å¡«ï¼Œå•æ—¥è¦†ç›–æ—¶ç­‰äºstart_dateï¼‰
  rule_id TEXT,                  -- å…³è”è§„åˆ™
  type TEXT NOT NULL,            -- è¦†ç›–ç±»å‹
  new_time TEXT,
  new_end_time TEXT,
  new_title TEXT,
  new_description TEXT,
  metadata TEXT,                 -- JSON æ ¼å¼
  created_at TEXT NOT NULL
);
```

**âš ï¸ v8 æ•°æ®åº“å‡çº§è¯´æ˜**
- v8 ç‰ˆæœ¬ä¼šè‡ªåŠ¨å°†æ‰€æœ‰ `end_date = NULL` çš„è®°å½•æ›´æ–°ä¸º `end_date = start_date`
- å‡çº§åä¸å†æ”¯æŒ NULL å€¼ï¼Œä»£ç ä¼šæŠ›å‡ºå¼‚å¸¸è¦æ±‚å‡çº§

### 3ï¸âƒ£ Scheduleï¼ˆæ—¥ç¨‹è§†å›¾å¯¹è±¡ï¼‰

**ä½œç”¨**ï¼šå‰ç«¯æ˜¾ç¤ºçš„æœ€ç»ˆæ—¥ç¨‹ï¼ˆåŠ¨æ€ç”Ÿæˆï¼Œä¸å­˜å‚¨ï¼‰

```dart
class Schedule {
  String id;               // æ ¼å¼ï¼šruleId_date
  String title;
  String? description;
  DateTime date;
  DateTime? startTime;
  DateTime? endTime;
  bool isCompleted;        // æ˜¯å¦å®Œæˆ
  String? sourceTemplateId; // æºè§„åˆ™ID
  DateTime createdAt;
  DateTime updatedAt;
}
```

---

## è¯»å†™æµç¨‹

### ğŸ“– è¯»å–æµç¨‹ï¼š`getSchedulesByDate(date)`

**æ‰§è¡Œæ­¥éª¤**ï¼ˆO(1) å¤æ‚åº¦ï¼‰ï¼š

```dart
// 1. æŸ¥è¯¢è¯¥æ—¥æœŸçš„è¦†ç›–ï¼ˆåŒºåˆ†ç±»å‹ï¼‰
// - complete ç±»å‹ï¼šç²¾ç¡®åŒ¹é… start_date = ?
// - å…¶ä»–ç±»å‹ï¼šèŒƒå›´æŸ¥è¯¢ start_date <= ? AND end_date >= ?
final rangeOverrides = query('start_date <= ? AND end_date >= ? AND type != complete');
final completeOverrides = query('start_date = ? AND type = complete');
final overrides = [...rangeOverrides, ...completeOverrides];

// 2. æŸ¥è¯¢æ‰€æœ‰å¯ç”¨çš„è§„åˆ™
final rules = query('is_enabled = 1');

// 3. åˆ¤æ–­æ—¥æœŸç±»å‹
final isWeekend = date.weekday >= 6;
final isHoliday = await _isHoliday(date);
final isWorkday = !isWeekend && !isHoliday;

// 4. ç­›é€‰é€‚ç”¨çš„è§„åˆ™
final applicableRules = rules.where((rule) {
  // è·³è¿‡è¢« skip è¦†ç›–çš„è§„åˆ™
  if (skippedRuleIds.contains(rule.id)) return false;
  // æ£€æŸ¥è§„åˆ™æ˜¯å¦é€‚ç”¨äºè¯¥æ—¥æœŸ
  return rule.appliesTo(date, isWorkday, isHoliday);
});

// 5. åº”ç”¨ä¿®æ”¹è¦†ç›–ï¼ˆmodifyTimeã€modifyï¼‰
for (var override in modifyOverrides) {
  // ä¿®æ”¹å¯¹åº”è§„åˆ™çš„æ—¶é—´ã€æ ‡é¢˜ã€æè¿°ç­‰
}

// 6. æ£€æŸ¥å®ŒæˆçŠ¶æ€è¦†ç›–
final completedRuleIds = completeOverrides
    .map((o) => o.ruleId)
    .toSet();

// 7. ç”Ÿæˆ Schedule å¯¹è±¡
final schedules = applicableRules.map((rule) {
  return Schedule(
    id: '${rule.id}_${date.toIso8601String()}',
    title: rule.title,
    isCompleted: completedRuleIds.contains(rule.id), // âœ…
    sourceTemplateId: rule.id,
    ...
  );
});

// 8. æŒ‰æ—¶é—´æ’åº
schedules.sort((a, b) => a.startTime.compareTo(b.startTime));

return schedules;
```

**æŸ¥è¯¢æ€§èƒ½**ï¼š
- è¦†ç›–æŸ¥è¯¢ï¼šç´¢å¼• `(start_date, end_date, type)` â†’ O(log n)
- è§„åˆ™æŸ¥è¯¢ï¼šç´¢å¼• `(is_enabled)` â†’ O(m)ï¼Œm ä¸ºå¯ç”¨è§„åˆ™æ•°
- æ€»å¤æ‚åº¦ï¼š**O(1)** å› ä¸ºè§„åˆ™æ•°é‡å›ºå®šä¸”å¾ˆå°

### âœï¸ å†™å…¥æµç¨‹

#### 1. åˆ›å»ºè§„åˆ™

```dart
// UI: RuleEditDialog
// Service: DatabaseService.insertRule()

await db.insert('schedule_rules', rule.toMap());
```

#### 2. åˆ›å»ºè¦†ç›–

**åœºæ™¯ Aï¼šç”¨æˆ·æ‰“å‹¾/å–æ¶ˆ**

```dart
// UI: ScheduleItem checkbox
// Service: DatabaseService.toggleScheduleComplete(date, ruleId, isCompleted)

// é˜²é‡å¤æ£€æŸ¥
final existing = query('start_date = ? AND rule_id = ? AND type = complete');

if (isCompleted && existing.isEmpty) {
  insert(ScheduleOverride(
    startDate: date,
    endDate: date,  // âœ… å•æ—¥è¦†ç›–ï¼šendDate = startDate
    ruleId: ruleId,
    type: OverrideType.complete,
  ));
} else if (!isCompleted && existing.isNotEmpty) {
  delete('id = ?', existing.first['id']);
}
```

**åœºæ™¯ Bï¼šç”¨æˆ·ç¼–è¾‘æ—¥ç¨‹**

```dart
// UI: ScheduleEditDialogï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨èœå•è·³è½¬ï¼‰
// ç°åœ¨ç”¨æˆ·ç‚¹å‡»"ç¼–è¾‘è§„åˆ™"æ‰“å¼€ RuleEditDialog

if (schedule.sourceTemplateId != null) {
  // æ‰“å¼€è§„åˆ™ç¼–è¾‘å¯¹è¯æ¡†
  final rule = await getRuleById(schedule.sourceTemplateId);
  showDialog(RuleEditDialog(rule: rule));
}
```

**åœºæ™¯ Cï¼šç”¨æˆ·åˆ é™¤æ—¥ç¨‹**

```dart
// UI: ScheduleDeleteDialog
// æä¾›ä¸¤ä¸ªé€‰é¡¹ï¼šåˆ é™¤è§„åˆ™ / åªè·³è¿‡ä»Šå¤©

if (deleteRule) {
  await deleteRule(schedule.sourceTemplateId);
} else {
  insert(ScheduleOverride(
    startDate: schedule.date,
    endDate: schedule.date,  // âœ… å•æ—¥è¦†ç›–ï¼šendDate = startDate
    ruleId: schedule.sourceTemplateId,
    type: OverrideType.skip,
  ));
}
```

**åœºæ™¯ Dï¼šAI åˆ›å»ºè¦†ç›–**

```dart
// Service: GptService._overrideSchedule()

final override = ScheduleOverride(
  startDate: date,
  endDate: date,  // âœ… å•æ—¥è¦†ç›–ï¼šendDate = startDate
  ruleId: ruleId,
  type: type,  // skip/modifyTime/modify/replace
  newTime: newTime,
  newTitle: newTitle,
  ...
);

await db.insertOverride(override);
```

---

## AI é›†æˆ

### AI èƒ½åŠ›

AI é€šè¿‡ **Function Calling** æœºåˆ¶æ“ä½œæ—¥ç¨‹ç³»ç»Ÿï¼š

| Function | è¯´æ˜ | æ“ä½œå±‚ |
|----------|------|--------|
| `createScheduleRule` | åˆ›å»ºè§„åˆ™ | Rule |
| `overrideSchedule` | è¦†ç›–æ—¥ç¨‹ | Override |
| `modifySchedule` | ä¿®æ”¹è§„åˆ™ | Rule |
| `deleteScheduleRule` | åˆ é™¤è§„åˆ™ | Rule |

### AI Prompt æ ¸å¿ƒå­—æ®µ

```json
{
  "name": "createScheduleRule",
  "parameters": {
    "title": "string",
    "time": "HH:mm",
    "end_time": "HH:mm",
    "condition_type": "daily|workday|restday|weekend|holiday|weekday|interval|specific_date",
    "weekday": 1-7,
    "interval_days": "number",
    "specific_date": "YYYY-MM-DD"
  }
}
```

**âš ï¸ æ³¨æ„**ï¼š
- ä½¿ç”¨ `condition_type` ä¸æ˜¯ ~~`template_type`~~ æˆ– ~~`recurrence`~~
- ä¸åŒ…å« ~~`priority`~~ å­—æ®µï¼ˆå·²åºŸå¼ƒï¼‰

### AI å¤„ç†æµç¨‹

```
ç”¨æˆ·è¾“å…¥ï¼š"æ˜å¤©æ™¨è·‘æ”¹æˆ 10 ç‚¹"
    â†“
GPT è§£æ â†’ overrideSchedule
    â†“
{
  "date": "2025-12-02",
  "title": "æ™¨è·‘",
  "new_time": "10:00"
}
    â†“
GptService._overrideSchedule()
    â†“
1. æŸ¥æ‰¾è§„åˆ™ï¼šfindRuleId(title="æ™¨è·‘")
2. åˆ›å»ºè¦†ç›–ï¼šScheduleOverride(
     startDate: 2025-12-02,
     endDate: 2025-12-02,  // å•æ—¥è¦†ç›–
     type: OverrideType.modifyTime,
     newTime: "10:00"
   )
3. æ’å…¥æ•°æ®åº“
    â†“
UI åˆ·æ–° â†’ æ˜¾ç¤ºä¿®æ”¹åçš„æ—¥ç¨‹
```

---

## UI äº¤äº’

### ä¸»ç•Œé¢ï¼šScheduleScreen

**åŠŸèƒ½**ï¼š
- æ˜¾ç¤ºå½“å¤©ã€å‰ä¸€å¤©ã€åä¸€å¤©æ—¥ç¨‹
- AI èŠå¤©é¢æ¿
- æ—¥æœŸé€‰æ‹©å™¨
- æ—¥ç¨‹åˆ—è¡¨

**æ—¥ç¨‹é¡¹æ˜¾ç¤º**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â˜‘ [æ”¹] æ™¨è·‘         å·¥ä½œæ—¥          â”‚
â”‚   09:00 - 10:00                    â”‚
â”‚   æè¿°ä¿¡æ¯...                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†‘   â†‘    â†‘          â†‘
  â”‚   â”‚    â”‚          â””â”€ ç±»å‹æ ‡ç­¾ï¼ˆåŸºäº condition_typeï¼‰
  â”‚   â”‚    â””â”€ æ ‡é¢˜
  â”‚   â””â”€ è¦†ç›–æ ‡è®°ï¼ˆç»¿è‰²"æ”¹"badgeï¼‰
  â””â”€ å®ŒæˆçŠ¶æ€ï¼ˆcheckboxï¼‰
```

**é•¿æŒ‰/ç‚¹å‡»èœå•**ï¼š
- ç¼–è¾‘è§„åˆ™ â†’ æ‰“å¼€ `RuleEditDialog`
- ç®¡ç†è¦†ç›– â†’ æ‰“å¼€ `OverrideListDialog`
- åˆ é™¤ â†’ æ‰“å¼€ `ScheduleDeleteDialog`

### è§„åˆ™ç®¡ç†ï¼šRuleManagerScreen

**å…¥å£**ï¼šè®¾ç½® â†’ æ—¥ç¨‹è§„åˆ™ç®¡ç†

**åŠŸèƒ½**ï¼š
- æŸ¥çœ‹æ‰€æœ‰è§„åˆ™
- æ·»åŠ /ç¼–è¾‘/åˆ é™¤è§„åˆ™
- å¯ç”¨/ç¦ç”¨è§„åˆ™

**ç•Œé¢**ï¼š
```
è§„åˆ™åˆ—è¡¨
â”œâ”€ [âœ“] æ¯å¤© 09:00 æ™¨è·‘        [ç¼–è¾‘] [åˆ é™¤]
â”œâ”€ [âœ“] å·¥ä½œæ—¥ 08:30 ä¸Šç­      [ç¼–è¾‘] [åˆ é™¤]
â”œâ”€ [âœ—] å‘¨æœ« 14:00 ç”µå½±        [ç¼–è¾‘] [åˆ é™¤]
â””â”€ [+] æ·»åŠ æ–°è§„åˆ™
```

### è§„åˆ™ç¼–è¾‘ï¼šRuleEditDialog

**å­—æ®µ**ï¼š
- æ ‡é¢˜ã€æè¿°
- å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´
- æ¡ä»¶ç±»å‹ï¼ˆä¸‹æ‹‰é€‰æ‹©ï¼‰
  - æ¯å¤©
  - å·¥ä½œæ—¥ / ä¼‘æ¯æ—¥
  - å‘¨æœ« / èŠ‚å‡æ—¥
  - ç‰¹å®šæ˜ŸæœŸï¼ˆé€‰æ‹© 1-7ï¼‰
  - é—´éš”å¤©æ•°ï¼ˆè¾“å…¥æ•°å­—ï¼‰
  - ç‰¹å®šæ—¥æœŸï¼ˆé€‰æ‹©æ—¥æœŸï¼‰

### è¦†ç›–ç®¡ç†ï¼šOverrideListDialog

**åŠŸèƒ½**ï¼šæŸ¥çœ‹å’Œç®¡ç†æŸä¸ªè§„åˆ™çš„æ‰€æœ‰è¦†ç›–

**ç•Œé¢**ï¼š
```
è§„åˆ™ï¼šæ™¨è·‘ (09:00 - 10:00)

è¦†ç›–åˆ—è¡¨
â”œâ”€ 2025-12-02 ~ 2025-12-02   ä¿®æ”¹æ—¶é—´ â†’ 10:00    [åˆ é™¤]
â”œâ”€ 2025-12-05 ~ 2025-12-05   è·³è¿‡                [åˆ é™¤]
â””â”€ [+] æ·»åŠ è¦†ç›–
```

### è¦†ç›–ç¼–è¾‘ï¼šOverrideEditDialog

**å­—æ®µ**ï¼š
- æ—¥æœŸèŒƒå›´ï¼ˆå¼€å§‹æ—¥æœŸ ~ ç»“æŸæ—¥æœŸï¼‰
- è¦†ç›–ç±»å‹ï¼ˆä¸‹æ‹‰ï¼‰
  - è·³è¿‡
  - ä¿®æ”¹æ—¶é—´
  - ä¿®æ”¹ï¼ˆå¤šå±æ€§ï¼‰
  - æ›¿æ¢
- æ–°æ—¶é—´ã€æ–°ç»“æŸæ—¶é—´
- æ–°æ ‡é¢˜ã€æ–°æè¿°

---

## æŠ€æœ¯è¦ç‚¹

### ğŸ”’ æ•°æ®ä¸€è‡´æ€§

1. **å”¯ä¸€æ€§ä¿è¯**
   - è§„åˆ™ï¼š`id` ä¸»é”®
   - è¦†ç›–ï¼š`(start_date, rule_id, type)` ç»„åˆå”¯ä¸€ï¼ˆä»£ç å±‚é¢æ£€æŸ¥ï¼‰

2. **çº§è”åˆ é™¤**
   - åˆ é™¤è§„åˆ™ â†’ è‡ªåŠ¨åˆ é™¤ç›¸å…³è¦†ç›–
   - åˆ é™¤è¦†ç›– â†’ ä¸å½±å“è§„åˆ™

3. **äº‹åŠ¡å®‰å…¨**
   - æ‰€æœ‰å†™æ“ä½œä½¿ç”¨æ•°æ®åº“äº‹åŠ¡
   - å¼‚å¸¸å›æ»šä¿è¯æ•°æ®å®Œæ•´æ€§

### âš¡ æ€§èƒ½ä¼˜åŒ–

1. **æŸ¥è¯¢ä¼˜åŒ–**
   - ç´¢å¼•ï¼š`(start_date, end_date, type)`
   - ç¼“å­˜ï¼šè§„åˆ™ç¼“å­˜ `_rulesCache`
   - å•æ¬¡æŸ¥è¯¢ï¼šæ‰€æœ‰æ•°æ®ä¸€æ¬¡è·å–

2. **å†…å­˜ä¼˜åŒ–**
   - Schedule å¯¹è±¡åŠ¨æ€ç”Ÿæˆï¼Œä¸æŒä¹…åŒ–
   - åªåŠ è½½å½“å¤©Â±1 å¤©çš„æ•°æ®

3. **UI ä¼˜åŒ–**
   - æ»šåŠ¨åˆ°å½“å‰æ—¥ç¨‹
   - è™šæ‹Ÿåˆ—è¡¨ï¼ˆæœªæ¥å¯ä¼˜åŒ–ï¼‰

### ğŸ›¡ï¸ é”™è¯¯å¤„ç†

1. **ç©ºå€¼å¤„ç†**
   - `time`ã€`endTime` å¯ä¸º null
   - `description` å¯ä¸º null

2. **è¾¹ç•Œæƒ…å†µ**
   - è§„åˆ™ä¸å­˜åœ¨ â†’ AI è¿”å›é”™è¯¯
   - æ—¥æœŸä¸å­˜åœ¨ â†’ ä¸ç”Ÿæˆæ—¥ç¨‹

3. **ç”¨æˆ·åé¦ˆ**
   - æ“ä½œæˆåŠŸ â†’ Toast æç¤º
   - æ“ä½œå¤±è´¥ â†’ é”™è¯¯å¯¹è¯æ¡†

---

## æ•°æ®æµç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šåˆ›å»ºè§„åˆ™

```
ç”¨æˆ·æ“ä½œï¼šè®¾ç½® â†’ è§„åˆ™ç®¡ç† â†’ æ·»åŠ è§„åˆ™
è¾“å…¥ï¼š
  - æ ‡é¢˜ï¼šæ™¨è·‘
  - æ—¶é—´ï¼š09:00 - 10:00
  - æ¡ä»¶ï¼šæ¯å¤©

æ•°æ®åº“ï¼š
INSERT INTO schedule_rules (
  id: "uuid-1",
  title: "æ™¨è·‘",
  time: "09:00",
  end_time: "10:00",
  condition_type: "daily",
  condition_data: "{}",
  is_enabled: 1
)

ç»“æœï¼š
  - 2025-12-01 09:00 æ™¨è·‘ âœ“
  - 2025-12-02 09:00 æ™¨è·‘ âœ“
  - 2025-12-03 09:00 æ™¨è·‘ âœ“
  - ...
```

### ç¤ºä¾‹ 2ï¼šä»Šå¤©æ‰“å‹¾

```
ç”¨æˆ·æ“ä½œï¼šç‚¹å‡» checkbox
æ—¥æœŸï¼š2025-12-01
è§„åˆ™ï¼šæ™¨è·‘ (uuid-1)

æ•°æ®åº“ï¼š
1. æŸ¥è¯¢ï¼šSELECT * WHERE start_date='2025-12-01' AND rule_id='uuid-1' AND type='complete'
   â†’ ä¸å­˜åœ¨

2. æ’å…¥ï¼šINSERT INTO schedule_overrides (
     id: "uuid-2",
     start_date: "2025-12-01",
     end_date: null,  â† å•æ—¥
     rule_id: "uuid-1",
     type: "complete"
   )

ç»“æœï¼š
  - 2025-12-01 09:00 æ™¨è·‘ âœ… (å·²å®Œæˆ)
  - 2025-12-02 09:00 æ™¨è·‘ â˜ (æœªå®Œæˆ)
  - 2025-12-03 09:00 æ™¨è·‘ â˜ (æœªå®Œæˆ)
```

### ç¤ºä¾‹ 3ï¼šAI ä¿®æ”¹æ˜å¤©æ—¶é—´

```
ç”¨æˆ·è¾“å…¥ï¼š"æ˜å¤©æ™¨è·‘æ”¹æˆ 10 ç‚¹"

AI å¤„ç†ï¼š
1. è§£æï¼šdate=2025-12-02, title="æ™¨è·‘", new_time="10:00"
2. æŸ¥æ‰¾è§„åˆ™ï¼šruleId = "uuid-1"
3. åˆ›å»ºè¦†ç›–ï¼š
   INSERT INTO schedule_overrides (
     id: "uuid-3",
     start_date: "2025-12-02",
     end_date: null,  â† å•æ—¥
     rule_id: "uuid-1",
     type: "modifyTime",
     new_time: "10:00"
   )

ç»“æœï¼š
  - 2025-12-01 09:00 æ™¨è·‘ âœ…
  - 2025-12-02 10:00 æ™¨è·‘ [æ”¹] â† æ˜¾ç¤ºç»¿è‰²"æ”¹"badge
  - 2025-12-03 09:00 æ™¨è·‘
```

### ç¤ºä¾‹ 4ï¼šè·³è¿‡å‘¨æœ«

```
ç”¨æˆ·æ“ä½œï¼šè¦†ç›–ç®¡ç† â†’ æ·»åŠ è¦†ç›–
è¾“å…¥ï¼š
  - æ—¥æœŸï¼š2025-12-06 ~ 2025-12-07 (å‘¨å…­å‘¨æ—¥)
  - ç±»å‹ï¼šè·³è¿‡

æ•°æ®åº“ï¼š
INSERT INTO schedule_overrides (
  id: "uuid-4",
  start_date: "2025-12-06",
  end_date: "2025-12-07",  â† èŒƒå›´
  rule_id: "uuid-1",
  type: "skip"
)

ç»“æœï¼š
  - 2025-12-05 09:00 æ™¨è·‘ âœ“
  - 2025-12-06 (æ— æ™¨è·‘) â† è¢«è·³è¿‡
  - 2025-12-07 (æ— æ™¨è·‘) â† è¢«è·³è¿‡
  - 2025-12-08 09:00 æ™¨è·‘ âœ“
```

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸ç›´æ¥å­˜å‚¨ Scheduleï¼Ÿ

**A**: è§„åˆ™é©±åŠ¨çš„è®¾è®¡é¿å…äº†å¤§é‡å†—ä½™æ•°æ®ã€‚

- âŒ æ—§æ–¹æ¡ˆï¼š1 æ¡è§„åˆ™ â†’ 365 å¤© = 365 æ¡ Schedule è®°å½•
- âœ… æ–°æ–¹æ¡ˆï¼š1 æ¡è§„åˆ™ â†’ åŠ¨æ€ç”Ÿæˆ = 1 æ¡ Rule è®°å½•

### Q2: complete ç±»å‹ä¸ºä»€ä¹ˆå¿…é¡»å•æ—¥ï¼Ÿ

**A**: å®ŒæˆçŠ¶æ€æ˜¯**äº‹å®æ€§æ•°æ®**ï¼Œä¸èƒ½è·¨å¤©ã€‚

- "ä»Šå¤©å®Œæˆ" â‰  "æ˜å¤©å®Œæˆ"
- æ¯å¤©ç‹¬ç«‹æ‰“å‹¾ï¼Œäº’ä¸å½±å“

### Q3: å¦‚ä½•é˜²æ­¢é‡å¤æ’å…¥ï¼Ÿ

**A**: å†™å…¥å‰å…ˆæŸ¥è¯¢æ˜¯å¦å­˜åœ¨ã€‚

```dart
final existing = query('start_date = ? AND rule_id = ? AND type = ?');
if (existing.isEmpty) {
  insert(...);
}
```

### Q4: AI ä¼šä¸ä¼šè¯¯åˆ æ•°æ®ï¼Ÿ

**A**: AI åªèƒ½æ“ä½œ Rule å’Œ Overrideï¼Œä¸”éœ€è¦æ˜ç¡®å‚æ•°ã€‚

- åˆ é™¤è§„åˆ™ï¼šéœ€è¦æä¾› `id` æˆ– `title`
- AI ä¸èƒ½ç›´æ¥è®¿é—®æ•°æ®åº“
- æ‰€æœ‰æ“ä½œç»è¿‡ Service å±‚éªŒè¯

### Q5: å¦‚ä½•è¿ç§»æ—§æ•°æ®ï¼Ÿ

**A**: æ•°æ®åº“å‡çº§æ—¶è‡ªåŠ¨è¿ç§»ï¼ˆå·²å®Œæˆï¼‰ã€‚

- v7 ä¹‹å‰ï¼šå­˜åœ¨ `priority` å­—æ®µ
- v7 ä¹‹åï¼šç§»é™¤ `priority`ï¼Œç®€åŒ– `_onUpgrade`
- æ— é—ç•™ç”¨æˆ·ï¼Œä¸éœ€è¦å…¼å®¹é€»è¾‘

---

## æ€»ç»“

### ç³»ç»Ÿä¼˜åŠ¿

âœ… **ç®€æ´**ï¼šè§„åˆ™ + è¦†ç›–ä¸¤å±‚ç»“æ„  
âœ… **é«˜æ•ˆ**ï¼šO(1) æŸ¥è¯¢ï¼ŒåŠ¨æ€ç”Ÿæˆ  
âœ… **çµæ´»**ï¼šå•æ—¥/èŒƒå›´è¦†ç›–è‡ªå¦‚åˆ‡æ¢  
âœ… **æ™ºèƒ½**ï¼šAI è‡ªç„¶è¯­è¨€æ“ä½œ  
âœ… **å¯é **ï¼šé˜²é‡å¤ã€äº‹åŠ¡å®‰å…¨

### è®¾è®¡åŸåˆ™

1. **æœ€å°åŒ–å­˜å‚¨**ï¼šåªå­˜è§„åˆ™ï¼Œä¸å­˜ç»“æœ
2. **å•ä¸€èŒè´£**ï¼šè§„åˆ™ç®¡æ¨¡æ¿ï¼Œè¦†ç›–ç®¡ä¿®æ”¹
3. **ç±»å‹å®‰å…¨**ï¼šå¼ºç±»å‹æšä¸¾ï¼Œé¿å…é­”æ³•å­—ç¬¦ä¸²
4. **ç”¨æˆ·å‹å¥½**ï¼šUI éšè—å¤æ‚åº¦ï¼Œæä¾›ç›´è§‚æ“ä½œ

### æœªæ¥æ‰©å±•

- [ ] è§„åˆ™æ¨¡æ¿å¸‚åœº
- [ ] åä½œæ—¥ç¨‹ï¼ˆå¤šäººå…±äº«ï¼‰
- [ ] æ™ºèƒ½æ¨èï¼ˆæ ¹æ®ä¹ æƒ¯è‡ªåŠ¨åˆ›å»ºè§„åˆ™ï¼‰
- [ ] ç»Ÿè®¡åˆ†æï¼ˆå®Œæˆç‡ã€æ—¶é—´åˆ†å¸ƒï¼‰

---

**æ–‡æ¡£ç»´æŠ¤**ï¼šå¦‚æœ‰ç–‘é—®æˆ–å‘ç°é”™è¯¯ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚
