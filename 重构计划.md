# 设置界面重构计划 - 分步执行指南

## 目标
将 `settings_screen.dart` 从 1020 行简化到约 600 行，减少 40% 代码量

## 重构原则
1. **不改变功能**：只优化实现方式
2. **一次一个**：每次只重构一个设置项
3. **立即测试**：每次改完立即运行测试

---

## Step 1: 准备工作（5分钟）

### 1.1 添加 SettingsService 到 Provider

在 `main.dart` 中添加：

```dart
// 在 SharedPreferences 初始化后
final prefs = await SharedPreferences.getInstance();
final settingsService = SettingsService(prefs);  // ← 添加这行

// 在 MultiProvider 中添加
ChangeNotifierProvider.value(value: settingsService),  // ← 添加这行
```

### 1.2 导入 SettingsService

在 `settings_screen.dart` 顶部添加：
```dart
import '../services/settings_service.dart';
```

---

## Step 2: 重构 showNestedSchedules（10分钟）⭐ 最简单，从这开始

### 2.1 删除本地状态
```dart
// ❌ 删除这行
bool _showNestedSchedules = false;
```

### 2.2 删除加载方法
```dart
// ❌ 删除整个方法
void _loadNestedScheduleSetting() async { ... }
```

### 2.3 删除 initState 调用
```dart
// ❌ 删除这行
_loadNestedScheduleSetting();
```

### 2.4 删除切换方法
```dart
// ❌ 删除整个方法
Future<void> _toggleNestedSchedules(bool enabled) async { ... }
```

### 2.5 替换 UI 部分

找到显示设置的部分，替换为：

```dart
// ✅ 新代码
Consumer<SettingsService>(
  builder: (context, settings, _) {
    return _buildSection(
      '显示设置',
      Icons.visibility,
      [
        SwitchListTile(
          title: const Text('显示嵌套日程'),
          subtitle: const Text('将包含在其他日程时间范围内的任务缩进显示'),
          value: settings.showNestedSchedules,
          onChanged: settings.setShowNestedSchedules,
          secondary: const Icon(Icons.subdirectory_arrow_right, color: Colors.blue),
        ),
      ],
    );
  },
)
```

### 2.6 测试
运行应用，测试显示设置开关是否正常工作。

**代码减少：约 20 行 → 5 行**

---

## Step 3: 重构位置设置（15分钟）⭐ 第二简单

### 3.1 删除本地状态
```dart
// ❌ 删除这两行
bool _autoLocationEnabled = true;
String _manualCity = '北京';
```

### 3.2 删除相关方法
```dart
// ❌ 删除这三个方法
void _loadLocationSettings() async { ... }
Future<void> _toggleAutoLocation(bool enabled) async { ... }
Future<void> _selectCity() async { ... }
```

### 3.3 删除 initState 调用
```dart
// ❌ 删除这行
_loadLocationSettings();
```

### 3.4 替换 UI
直接复制 `位置设置简化示例.dart` 中的 `_buildLocationSettings()` 方法

### 3.5 在 build 中调用
```dart
const SizedBox(height: 24),
_buildLocationSettings(),  // ← 用新方法
const SizedBox(height: 24),
```

### 3.6 测试
测试自动定位和手动选择城市功能。

**代码减少：约 60 行 → 30 行**

---

## Step 4: 重构通知设置（10分钟）

### 4.1 检查 NotificationService
确保它已经是 ChangeNotifier 并提供 getter

如果不是，需要先改造 `NotificationService`：
```dart
class NotificationService extends ChangeNotifier {
  bool _enabled = true;
  
  bool get isEnabled => _enabled;
  
  Future<void> setEnabled(bool value) async {
    _enabled = value;
    await _prefs.setBool('notification_enabled', value);
    notifyListeners();
  }
}
```

### 4.2 删除本地状态和方法
```dart
// ❌ 删除
bool _notificationEnabled = true;
void _loadNotificationSetting() async { ... }
Future<void> _toggleNotification(bool enabled) async { ... }
```

### 4.3 替换 UI
```dart
Consumer<NotificationService>(
  builder: (context, notificationService, _) {
    return _buildSection(
      '通知设置',
      Icons.notifications,
      [
        SwitchListTile(
          title: const Text('日程提醒'),
          subtitle: const Text('当日程到期时发送通知提醒'),
          value: notificationService.isEnabled,
          onChanged: notificationService.setEnabled,
          secondary: const Icon(Icons.alarm, color: Colors.orange),
        ),
      ],
    );
  },
)
```

---

## Step 5: 优化 API 配置（可选，较复杂）

API 配置部分由于涉及多个输入框和自动保存，建议保持现状或者：

### 简化方案：
1. 移除自动保存监听器，改为"保存"按钮
2. 使用 `TextEditingController` 的初始值直接从 Service 读取
3. 保存时直接调用 Service 方法

这部分比较复杂，建议最后做或者保持不变。

---

## Step 6: 清理和优化（5分钟）

### 6.1 移除未使用的导入
如果有 `SharedPreferences` 导入但没用到，删除它。

### 6.2 格式化代码
```bash
flutter format lib/screens/settings_screen.dart
```

### 6.3 检查代码行数
应该从 1020 行减少到约 600-700 行。

---

## 实施建议

### 推荐顺序（按难度）：
1. ✅ Step 2: showNestedSchedules（最简单，5分钟）
2. ✅ Step 3: 位置设置（简单，10分钟）
3. ✅ Step 4: 通知设置（简单，10分钟）
4. ⏸️ Step 5: API配置（复杂，可跳过）

### 每次重构后检查清单：
- [ ] 应用能正常启动
- [ ] 设置能正常切换
- [ ] 设置重启后保持
- [ ] 没有报错或警告

---

## 重构效果预估

| 项目 | 重构前 | 重构后 | 减少 |
|------|--------|--------|------|
| 状态变量 | 7个 | 0个 | -100% |
| 加载方法 | 4个 | 0个 | -100% |
| 设置方法 | 5个 | 0个 | -100% |
| 总代码行数 | ~1020 | ~650 | -36% |

---

## 常见问题

### Q: Consumer 会不会导致整个界面重建？
A: 不会。Consumer 只重建它包裹的部分。而且位置设置不会频繁变化。

### Q: 如果想进一步优化性能？
A: 使用 `Selector` 代替 `Consumer`，只监听特定字段。

### Q: 是否需要一次性全部重构？
A: **不需要！** 建议先做 Step 2，测试通过后再做其他。

### Q: 如果出问题了怎么办？
A: Git 回退到上一个版本，或者只重构一个再提交。

---

## 下一步

**现在就开始 Step 2！** 

只需要 5 分钟，你就能看到明显的简化效果，这会大大减轻你的焦虑感。

完成后告诉我结果，我们再继续下一步！
