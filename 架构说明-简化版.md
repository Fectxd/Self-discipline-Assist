# 日程系统架构 - 简化说明

## 核心理念

**一句话总结**：用户说人话创建日程，系统自动处理覆盖关系。

## 用户视角（怎么用）

### 场景1：不同日期不同时间

```
用户："我每天9点起床"
     → 创建规则：起床 09:00 每天

用户："周末我要12点起"  
     → 创建规则：起床 12:00 周末

结果：
- 周一到周五显示：起床 09:00 ✅
- 周六周日显示：起床 12:00 ✅（自动覆盖了"每天9点"）
```

### 场景2：特定星期特殊安排

```
用户："每天下午健身"
     → 创建规则：健身 15:00 每天

用户："每周一晚上开会"
     → 创建规则：开会 19:00 周一

结果：
- 周一：健身 15:00、开会 19:00（两个都显示，时间不冲突）
- 周二到周日：健身 15:00
```

### 场景3：节假日特殊安排

```
用户："工作日8点上班"
     → 创建规则：上班 08:00 工作日

用户："节假日出去玩"
     → 创建规则：出游 10:00 节假日

结果：
- 工作日：上班 08:00
- 周末：不显示上班
- 国庆节：出游 10:00（节假日）
```

## 系统内部逻辑（自动处理）

### 优先级规则（5级，够用即可）

| 级别 | 类型 | 覆盖范围 | 示例 | 标签显示 |
|------|------|---------|------|---------|
| 1 | 每天 | 所有日期 | 每天6点起床 | 每天 |
| 2 | 工作日/休息日 | 工作日或休息日 | 工作日晨练 | 工作日 |
| 3 | 周末/节假日 | 周末或节假日 | 周末睡懒觉 | 周末 |
| 4 | 周X | 特定星期几 | 每周一开会 | 周一 |
| 5 | 特定日期 | 单个日期 | 12-25聚餐 | 单次 |

**特殊类型**：
- **每隔N天**：优先级2（类似工作日）
- **休息日** = 周末 + 节假日（优先级2）

### 覆盖规则

同一天查询日程时：

1. **找出所有匹配的规则**
   ```
   2025-12-27(周六)查询时：
   - "每天9点起床" ✓
   - "周末12点起床" ✓
   - "工作日8点上班" ✗（不匹配）
   ```

2. **按 `title` 分组**
   ```
   "起床" 组：
   - 规则A：每天 09:00 (priority=1)
   - 规则B：周末 12:00 (priority=3)
   ```

3. **保留优先级最高的**
   ```
   → 选择规则B（priority=3 > priority=1）
   → 显示：起床 12:00 周末
   ```

4. **不同标题不冲突**
   ```
   "起床" 12:00
   "健身" 15:00  
   "看电影" 19:00  ← 都会显示
   ```

## GPT 自动处理

### 用户说话 → 规则创建

| 用户输入 | GPT理解 | 创建的规则 |
|---------|--------|-----------|
| "每天9点起床" | daily | `{title:"起床", time:"09:00", condition:daily, priority:1}` |
| "工作日8点上班" | workday | `{title:"上班", time:"08:00", condition:workday, priority:2}` |
| "周末睡到12点" | weekend | `{title:"起床", time:"12:00", condition:weekend, priority:3}` |
| "每周一开会" | weekly(1) | `{title:"开会", time:"14:00", condition:weekday(1), priority:4}` |
| "明天面试" | specific | `{title:"面试", time:"10:00", condition:specific(2025-11-25), priority:5}` |
| "每隔3天吃药" | interval(3) | `{title:"吃药", time:"08:00", condition:interval(3,today), priority:2}` |

### GPT 智能提示

当用户创建可能冲突的规则时，GPT会提示：

```
用户："每天9点起床"
GPT："已创建规则：每天 09:00 起床"

用户："周末12点起"  
GPT："检测到同名规则'起床'，我会创建周末专用规则。
     工作日：09:00起床
     周末：12:00起床
     已提交审批。"
```

## 数据结构

### schedule_rules 表（唯一核心表）

```sql
CREATE TABLE schedule_rules (
  id TEXT PRIMARY KEY,
  title TEXT NOT NULL,           -- "起床"、"上班"
  description TEXT,
  time TEXT,                      -- "09:00"
  priority INTEGER NOT NULL,      -- 1-5
  condition TEXT NOT NULL,        -- JSON: {type, weekday?, startDate?, intervalDays?}
  created_at TEXT,
  is_enabled INTEGER DEFAULT 1
);
```

### 条件类型（简化到5种）

```dart
enum ConditionType {
  daily,        // 每天 - priority自动=1
  workday,      // 工作日 - priority自动=2
  weekend,      // 周末 - priority自动=3
  weekday,      // 周X - priority自动=4
  specificDate, // 特定日期 - priority自动=5
  
  // 特殊类型
  interval,     // 每隔N天 - priority=2
  holiday,      // 节假日 - priority=3
  restday,      // 休息日(周末+节假日) - priority=2
}
```

### 临时修改（schedule_overrides）

用于"仅修改某一天"：

```
用户："明天11点起"（不改规则）
→ 创建override: {rule_id: xxx, date: "2025-11-25", new_time: "11:00"}
```

## UI 显示

### 标签颜色（简化到4种）

- **灰色**：每天
- **绿色**：工作日/休息日
- **粉色**：周末/节假日
- **橙色**：周X
- **紫色**：单次

### 标签文字（精确显示）

- "每天"
- "工作日" / "休息日"
- "周末" / "节假日"
- "周一" ~ "周日"
- "每3天"
- "单次"

## 优势

✅ **用户不需要理解优先级** - 只需说人话
✅ **自动处理冲突** - 系统按覆盖范围自动选择
✅ **灵活扩展** - 可以为同一件事创建多个时间规则
✅ **简单清晰** - 5级优先级，够用且易懂

## 示例场景

### 完整示例：一周的"起床"时间

```
规则1: "起床" 06:00 每天 (priority=1)
规则2: "起床" 09:00 周末 (priority=3)
规则3: "起床" 11:00 周日 (priority=4)

结果：
周一~周五: 06:00（规则1）
周六: 09:00（规则2覆盖规则1）
周日: 11:00（规则3覆盖规则2和规则1）✅
```

### GPT对话示例

```
用户："我要每天6点起床"
GPT："好的，已创建每天06:00的起床日程。"

用户："周末我想睡到9点"
GPT："明白，我会调整周末的起床时间。
     工作日：06:00起床
     周末：09:00起床
     已提交审批。"

用户："周日可以睡到11点"
GPT："收到，周日单独设置11点。
     周一~周五：06:00
     周六：09:00
     周日：11:00 ✅
     已提交审批。"
```

## 总结

**一切都是规则**，用户说人话，GPT创建规则，系统自动覆盖。
简单、直观、强大。

## 导入导出功能

### 快速备份

点击日程页面右上角 ⋮ 菜单 → **快速备份**
- 自动保存到文档目录
- 文件名：`schedule_backup_YYYYMMDD_HHMMSS.json`
- 包含所有规则和临时覆盖

### 导出JSON

点击 ⋮ 菜单 → **导出JSON**
- 选择保存位置
- JSON格式，可用于备份和迁移
- 包含完整数据结构

### 导出文本

点击 ⋮ 菜单 → **导出文本**
- 人类可读的格式
- 按优先级分组显示
- 适合查看和打印

### 导入规则

点击 ⋮ 菜单 → **导入规则**

两种模式：
1. **合并导入** - 保留现有规则，添加新规则
2. **清空后导入** - 删除所有现有规则，使用导入的规则

### 文件格式

导出的JSON文件格式：
```json
{
  "version": "1.0",
  "export_time": "2025-11-24T12:00:00.000",
  "rules": [
    {
      "id": "uuid",
      "title": "起床",
      "time": "09:00",
      "priority": 1,
      "condition": {
        "type": "daily"
      }
    }
  ],
  "overrides": []
}
```

### 使用场景

✅ **备份数据** - 定期快速备份
✅ **迁移设备** - 导出后在新设备导入
✅ **分享规则** - 导出文本分享给他人参考
✅ **恢复数据** - 出错后从备份恢复
