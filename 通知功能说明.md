# 日程通知功能说明

## 功能概述

应用现已支持日程到期时的消息提醒功能，默认开启。用户可以在设置页面中控制通知开关。

## 主要特性

### 1. 自动通知
- ✅ 每分钟自动检查即将到期的日程
- ✅ 日程开始时间到达时自动发送通知
- ✅ 通知内容包括日程标题、时间范围和描述
- ✅ 已完成的日程不会发送通知
- ✅ 每个日程每天只通知一次

### 2. 设置控制
- ✅ 默认开启通知功能
- ✅ 可在"设置 > 通知设置"中关闭
- ✅ 首次开启时会请求通知权限

### 3. 平台支持
- ✅ **Android**: 完整支持，包括通知权限申请（Android 13+）
- ✅ **Windows**: 完整支持
- ⚠️ **iOS/macOS**: 代码已准备，需要配置 Info.plist（项目暂未创建iOS目录）

## 技术实现

### 核心服务

#### NotificationService (通知服务)
- 位置: `lib/services/notification_service.dart`
- 功能:
  - 初始化通知系统
  - 请求和检查通知权限
  - 发送即时通知
  - 管理通知开关设置

#### ScheduleNotificationService (日程通知调度)
- 位置: `lib/services/schedule_notification_service.dart`
- 功能:
  - 每分钟检查一次日程
  - 自动发送到期日程的通知
  - 防止重复通知

### 权限配置

#### Android (AndroidManifest.xml)
```xml
<!-- 通知权限 (Android 13+) -->
<uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>

<!-- 精确闹钟权限（用于精确的日程提醒） -->
<uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM"/>
<uses-permission android:name="android.permission.USE_EXACT_ALARM"/>

<!-- 唤醒权限（用于后台通知） -->
<uses-permission android:name="android.permission.WAKE_LOCK"/>
```

#### iOS (Info.plist) - 待配置
如果未来需要支持iOS，需要在 `ios/Runner/Info.plist` 中添加：
```xml
<key>UIBackgroundModes</key>
<array>
    <string>remote-notification</string>
</array>
```

### 依赖包
- `flutter_local_notifications: ^18.0.1` - 跨平台通知
- `permission_handler: ^11.3.1` - 权限管理

## 使用方式

### 用户操作

1. **开启/关闭通知**
   - 打开应用
   - 进入"设置"页面
   - 找到"通知设置"部分
   - 切换"日程提醒"开关

2. **首次使用**
   - 首次开启通知时，系统会请求权限
   - Android 13+: 会弹出权限对话框
   - 如果拒绝权限，可在系统设置中手动开启

### 通知效果

当日程到期时，会收到如下格式的通知：

```
📅 晨跑
时间: 06:00 - 07:00
每天早上的晨跑锻炼
```

## 注意事项

### 1. 时区处理
- 所有时间都使用本地时区
- 不需要考虑时区转换
- 到哪个时区就使用哪个时区的时间

### 2. 实时检查机制
- 采用每分钟轮询检查的方式
- 比定时通知更可靠（不受应用重启影响）
- 确保不会漏掉任何日程提醒

### 3. 省电优化
- 检查逻辑轻量级，对电池影响很小
- 只在有通知需要时才发送
- 不会重复发送同一日程的通知

### 4. 后台运行
- Android: 应用在后台时通知仍然工作
- Windows: 桌面应用正常运行即可
- iOS: 需要额外的后台配置（待实现）

## 故障排除

### 收不到通知？

1. **检查通知开关**
   - 确认应用内通知开关已开启
   - 检查系统通知权限是否授予

2. **检查日程时间**
   - 确认日程有设置开始时间
   - 确认日程未标记为已完成

3. **Android特殊情况**
   - 某些厂商系统（小米、华为等）可能需要手动设置应用自启动
   - 检查是否开启了省电模式限制

4. **Windows特殊情况**
   - 确认系统通知中心已开启
   - 检查"勿扰模式"是否开启

## 未来改进

- [ ] 支持提前N分钟提醒
- [ ] 支持通知声音自定义
- [ ] 支持重复提醒
- [ ] iOS平台完整支持
- [ ] 通知历史记录

## 文件清单

### 新增文件
- `lib/services/notification_service.dart` - 通知服务
- `lib/services/schedule_notification_service.dart` - 日程通知调度
- `通知功能说明.md` - 本说明文档

### 修改文件
- `lib/main.dart` - 初始化通知服务
- `lib/screens/settings_screen.dart` - 添加通知设置UI
- `android/app/src/main/AndroidManifest.xml` - 添加Android权限
- `pubspec.yaml` - 添加依赖包
