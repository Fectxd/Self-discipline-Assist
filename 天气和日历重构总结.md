# å¤©æ°”å’Œæ—¥å†é‡æ„æ€»ç»“

**é‡æ„æ—¥æœŸ**: 2025-12-18
**é‡æ„ç›®æ ‡**: ä½¿ç”¨MSN APIæ›¿æ¢æ—§çš„å¤©æ°”å’Œä½ç½®æœåŠ¡ï¼Œå®ç°å¯é…ç½®çš„å°éƒ¨ä»¶ç³»ç»Ÿ

---

## âœ¨ é‡å¤§æ”¹è¿›

### 1. ç»Ÿä¸€çš„MSN APIæœåŠ¡

**æ–°å¢æ–‡ä»¶**: `lib/services/msn_service.dart`

- å•ä¸€APIè·å–å¤©æ°”å’Œæ—¥å†æ•°æ®
- 15åˆ†é’Ÿæ™ºèƒ½ç¼“å­˜æœºåˆ¶
- è‡ªåŠ¨å®šä½ï¼ˆæ— éœ€æ‰‹åŠ¨é…ç½®åŸå¸‚ï¼‰
- ä¸°å¯Œçš„æ•°æ®ï¼š
  - å¤©æ°”ï¼šå®æ—¶æ¸©åº¦ã€ä½“æ„Ÿæ¸©åº¦ã€ç©ºæ°”è´¨é‡ã€5å¤©é¢„æŠ¥
  - æ—¥å†ï¼šå†œå†ã€å¹²æ”¯ã€ç”Ÿè‚–ã€æ˜Ÿåº§ã€å®œå¿Œã€æ¯æ—¥æ ¼è¨€ã€å¹´åº¦è¿›åº¦

### 2. å¯é…ç½®çš„å°éƒ¨ä»¶ç³»ç»Ÿ

**æ–°å¢æ–‡ä»¶**:
- `lib/models/dashboard_widget.dart` - å°éƒ¨ä»¶æ¨¡å‹
- `lib/services/dashboard_widget_service.dart` - å°éƒ¨ä»¶ç®¡ç†æœåŠ¡
- `lib/widgets/weather_widget_card.dart` - å¤©æ°”å¡ç‰‡UI
- `lib/widgets/calendar_widget_card.dart` - æ—¥å†å¡ç‰‡UI

**åŠŸèƒ½ç‰¹æ€§**:
- âœ… å¯æ·»åŠ /åˆ é™¤å°éƒ¨ä»¶
- âœ… å¯è°ƒæ•´æ˜¾ç¤ºé¡ºåº
- âœ… å¯åˆ‡æ¢æ˜¾ç¤º/éšè—
- âœ… ç»Ÿä¸€çš„å¡ç‰‡æ ·å¼
- âœ… ç‹¬ç«‹çš„åˆ·æ–°æŒ‰é’®

### 3. ä¼˜åŒ–çš„åŠ è½½ç­–ç•¥

**æ”¹è¿›å‰**: 
- UIæ¸²æŸ“æ—¶åŒæ­¥è·å–å¤©æ°”æ•°æ®
- å¯èƒ½é˜»å¡ç•Œé¢åŠ è½½
- å¤šä¸ªAPIéœ€è¦åˆ†åˆ«é…ç½®Key

**æ”¹è¿›å**:
- UIæ¸²æŸ“å®Œæˆåå¼‚æ­¥åŠ è½½æ•°æ®
- å…ˆæ˜¾ç¤ºç¼“å­˜æ•°æ®ï¼ˆå¦‚æœ‰ï¼‰
- åå°è‡ªåŠ¨æ›´æ–°
- æ— éœ€é…ç½®API Key

---

## ğŸ“¦ æ–°å¢ä¾èµ–

```yaml
dependencies:
  http: ^1.1.0  # MSN APIè¯·æ±‚
```

---

## ğŸ”„ æ¶æ„å˜åŒ–

### æœåŠ¡å±‚ï¼ˆServicesï¼‰

#### æ–°å¢
- `MsnService` - MSNæ•°æ®æœåŠ¡
- `DashboardWidgetService` - å°éƒ¨ä»¶ç®¡ç†

#### ä¿ç•™ï¼ˆæš‚æ—¶ï¼‰
- `WeatherService` - æ—§å¤©æ°”æœåŠ¡ï¼ˆæœªä½¿ç”¨ï¼Œå¾…åˆ é™¤ï¼‰
- `LocationService` - æ—§ä½ç½®æœåŠ¡ï¼ˆæœªä½¿ç”¨ï¼Œå¾…åˆ é™¤ï¼‰

### æ¨¡å‹å±‚ï¼ˆModelsï¼‰

#### æ–°å¢
- `DashboardWidget` - å°éƒ¨ä»¶é…ç½®æ¨¡å‹

### UIå±‚ï¼ˆWidgetsï¼‰

#### æ–°å¢
- `WeatherWidgetCard` - å¤©æ°”å°éƒ¨ä»¶å¡ç‰‡
- `CalendarWidgetCard` - æ—¥å†å°éƒ¨ä»¶å¡ç‰‡

#### ä¿®æ”¹
- `CalendarScreen` - ä½¿ç”¨æ–°çš„å°éƒ¨ä»¶ç³»ç»Ÿ
- `ScheduleHeader` - ä½¿ç”¨MSNå¤©æ°”æœåŠ¡

---

## ğŸ“ ä¸»è¦ä»£ç ä¿®æ”¹

### 1. main.dart

```dart
// æ–°å¢MSNæœåŠ¡
final msnService = MsnService();
await msnService.preloadCache();
final dashboardWidgetService = DashboardWidgetService(prefs);

// æ·»åŠ åˆ°Provider
ChangeNotifierProvider.value(value: msnService),
ChangeNotifierProvider.value(value: dashboardWidgetService),
```

### 2. calendar_screen.dart

**æ”¹å‰** - å›ºå®šçš„å¤©æ°”å¡ç‰‡:
```dart
Consumer<WeatherService>(
  builder: (context, weatherService, child) {
    if (weatherService.currentWeather != null) {
      return _buildWeatherCard(weatherService.currentWeather!);
    }
    return const SizedBox.shrink();
  },
),
```

**æ”¹å** - åŠ¨æ€å°éƒ¨ä»¶ç³»ç»Ÿ:
```dart
Consumer2<MsnService, DashboardWidgetService>(
  builder: (context, msnService, widgetService, child) {
    final widgets = widgetService.visibleWidgets;
    
    return Column(
      children: widgets.map((widget) {
        switch (widget.type) {
          case WidgetType.weather:
            return WeatherWidgetCard(
              weatherData: msnService.weatherData,
              onRefresh: () => msnService.fetchData(forceRefresh: true),
              onRemove: () => widgetService.removeWidget(widget.id),
            );
          case WidgetType.calendar:
            return CalendarWidgetCard(
              calendarData: msnService.calendarData,
              onRefresh: () => msnService.fetchData(forceRefresh: true),
              onRemove: () => widgetService.removeWidget(widget.id),
            );
        }
      }).toList(),
    );
  },
)
```

### 3. settings_screen.dart

**ç§»é™¤**:
- ä½ç½®è®¾ç½®ï¼ˆè‡ªåŠ¨å®šä½å¼€å…³ã€æ‰‹åŠ¨é€‰æ‹©åŸå¸‚ï¼‰
- åŸå¸‚é€‰æ‹©å¯¹è¯æ¡†

**æ–°å¢**:
- å°éƒ¨ä»¶ç®¡ç†ï¼ˆæ˜¾ç¤º/éšè—ã€æ’åºï¼‰
- MSNæ•°æ®æ‰‹åŠ¨åˆ·æ–°
- æ•°æ®æ›´æ–°æ—¶é—´æ˜¾ç¤º

---

## ğŸ¯ ç”¨æˆ·ä½“éªŒæå‡

| åŠŸèƒ½ | æ”¹è¿›å‰ | æ”¹è¿›å |
|-----|-------|-------|
| **å®šä½æ–¹å¼** | IPå®šä½ï¼ˆå¯èƒ½ä¸å‡†ç¡®ï¼‰ | MSNè‡ªåŠ¨å®šä½ï¼ˆæ›´ç²¾ç¡®ï¼‰ |
| **é…ç½®å¤æ‚åº¦** | éœ€è¦API Key + åŸå¸‚é€‰æ‹© | æ— éœ€é…ç½® |
| **æ•°æ®ä¸°å¯Œåº¦** | ä»…å¤©æ°” | å¤©æ°” + æ—¥å† + å®œå¿Œ + æ ¼è¨€ |
| **åŠ è½½é€Ÿåº¦** | å¯èƒ½é˜»å¡UI | å¼‚æ­¥åŠ è½½ä¸é˜»å¡ |
| **ç¼“å­˜ç­–ç•¥** | å¤æ‚çš„ä¸‰å±‚ç¼“å­˜ | ç®€å•çš„15åˆ†é’Ÿç¼“å­˜ |
| **å°éƒ¨ä»¶çµæ´»æ€§** | å›ºå®šæ˜¾ç¤º | å¯æ·»åŠ /åˆ é™¤/æ’åº |

---

## ğŸ¨ ç•Œé¢å˜åŒ–

### æ—¥å†é¡µé¢

**æ–°å¢åŠŸèƒ½**:
- å¤©æ°”å°éƒ¨ä»¶ï¼šè¯¦ç»†çš„å¤©æ°”ä¿¡æ¯å¡ç‰‡ï¼ˆå®æ—¶ + 5å¤©é¢„æŠ¥ + ç©ºæ°”è´¨é‡ï¼‰
- æ—¥å†å°éƒ¨ä»¶ï¼šå†œå†ã€å¹²æ”¯ã€å®œå¿Œã€æ ¼è¨€ã€å¹´åº¦è¿›åº¦
- å°éƒ¨ä»¶å¯ç‹¬ç«‹åˆ·æ–°å’Œç§»é™¤

### è®¾ç½®é¡µé¢

**æ–°å¢åŒºåŸŸ**:
- å¡ç‰‡å°éƒ¨ä»¶ç®¡ç†ï¼šæ§åˆ¶å°éƒ¨ä»¶æ˜¾ç¤º/éšè—
- MSNæ•°æ®ç®¡ç†ï¼šæŸ¥çœ‹æ›´æ–°æ—¶é—´ã€æ‰‹åŠ¨åˆ·æ–°

**ç§»é™¤åŒºåŸŸ**:
- ä½ç½®è®¾ç½®ï¼ˆä¸å†éœ€è¦ï¼‰

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### MSN API

**æ¥å£åœ°å€**: `https://assets.msn.cn/service/news/feed/pages/weblayout`

**è¯·æ±‚å‚æ•°**:
```dart
{
  'User': 'm-13A1CAFD74C4677709ACDC3875B96665',
  'activityId': '<éšæœºUUID>',
  'apikey': '0QfOX3Vn51YCzitbLaRkTTBadtWpgTN8NZLW0C1SEM',
  'audienceMode': 'adult',
  'cm': 'zh-cn',
  'it': 'edgeid',
  'ocid': 'hponeservicefeed',
  // ...
}
```

**è¿”å›æ•°æ®**:
```json
{
  "sections": [{
    "cards": [
      {"type": "WeatherSummary", "data": "{...}"},
      {"type": "RichCalendarSD", "data": "{...}"}
    ]
  }]
}
```

### ç¼“å­˜æœºåˆ¶

```dart
// 15åˆ†é’Ÿç¼“å­˜
static const Duration _cacheExpiration = Duration(minutes: 15);

// æ™ºèƒ½ç¼“å­˜æ£€æŸ¥
if (now.difference(_lastUpdateTime!) < _cacheExpiration) {
  return true; // ä½¿ç”¨ç¼“å­˜
}

// é¢„åŠ è½½ç¼“å­˜ï¼ˆåº”ç”¨å¯åŠ¨æ—¶ï¼‰
await msnService.preloadCache();
```

### æ•°æ®ç»“æ„

**å¤©æ°”æ•°æ®**:
```dart
{
  'current': {
    'temperature': 15,
    'feelsLike': 13,
    'condition': 'å¤šäº‘',
    'humidity': 65,
    'windSpeed': 12,
    'uvIndex': 3,
  },
  'airQuality': {
    'aqi': 42,
    'level': 'ä¼˜',
    'severity': 'è‰¯å¥½',
  },
  'forecast': [...]
}
```

**æ—¥å†æ•°æ®**:
```dart
{
  'lunar': {
    'year': 'ä¹™å·³',
    'month': 'åä¸€',
    'day': 'å»¿ä¹',
  },
  'ganZhi': {
    'year': 'ä¹™å·³',
    'month': 'æˆŠå­',
    'day': 'è¾›é…‰',
  },
  'zodiac': 'è›‡',
  'constellation': 'å°„æ‰‹åº§',
  'suitable': ['å«å¨¶', 'å‡ºè¡Œ', ...],
  'unsuitable': ['åŠ¨åœŸ', 'å®‰è‘¬', ...],
  'dailyQuote': {
    'text': '...',
    'author': '...',
  }
}
```

---

## ğŸ“‹ å¾…å¤„ç†äº‹é¡¹

- [x] åˆ›å»ºMSNæœåŠ¡
- [x] åˆ›å»ºå°éƒ¨ä»¶ç³»ç»Ÿ
- [x] é‡æ„æ—¥å†é¡µé¢
- [x] é‡æ„AIæ—¥ç¨‹å¤´éƒ¨
- [x] æ›´æ–°è®¾ç½®é¡µé¢
- [x] ä¿å­˜æ—§ä»£ç æ–‡æ¡£
- [ ] åˆ é™¤æ—§çš„WeatherServiceå’ŒLocationServiceæ–‡ä»¶
- [ ] åˆ é™¤åŸå¸‚é€‰æ‹©å¯¹è¯æ¡†
- [ ] åˆ é™¤cities.jsonèµ„æºæ–‡ä»¶
- [ ] æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
- [ ] æ›´æ–°ç”¨æˆ·æ–‡æ¡£

---

## ğŸ§ª æµ‹è¯•æ¸…å•

- [ ] åº”ç”¨å¯åŠ¨æ—¶ç¼“å­˜æ•°æ®åŠ è½½
- [ ] æ—¥å†é¡µé¢å°éƒ¨ä»¶æ˜¾ç¤º
- [ ] AIæ—¥ç¨‹é¡µé¢å¤©æ°”æ˜¾ç¤º
- [ ] æ‰‹åŠ¨åˆ·æ–°MSNæ•°æ®
- [ ] æ·»åŠ /åˆ é™¤å°éƒ¨ä»¶
- [ ] åˆ‡æ¢å°éƒ¨ä»¶æ˜¾ç¤º/éšè—
- [ ] 15åˆ†é’Ÿç¼“å­˜è¿‡æœŸè‡ªåŠ¨æ›´æ–°
- [ ] ç½‘ç»œå¼‚å¸¸æ—¶çš„é™çº§å¤„ç†
- [ ] è·¨æ—¥è‡ªåŠ¨åˆ·æ–°

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æ—§ç‰ˆå¤©æ°”å’Œä½ç½®æœåŠ¡æ–‡æ¡£](./æ—§ç‰ˆå¤©æ°”å’Œä½ç½®æœåŠ¡æ–‡æ¡£.md)
- [MSN APIæ–‡æ¡£](./æå–api/README.md)
- [Reactæºç åˆ†æ](./æå–api/docs/03-Reactæºç åˆ†æ.md)

---

**ç‰ˆæœ¬**: v2.0.0  
**ä½œè€…**: GitHub Copilot  
**å®Œæˆæ—¥æœŸ**: 2025-12-18
