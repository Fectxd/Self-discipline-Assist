# 城市定位设置功能说明

## 概述

本次更新为应用添加了灵活的城市定位设置功能，允许用户在自动IP定位和手动选择城市之间切换。

## 功能特性

### 1. 自动IP定位（默认开启）
- 使用IP地址自动识别用户当前所在城市
- 2小时内缓存定位结果，避免频繁API调用
- 适合大多数正常网络环境的用户

### 2. 手动选择城市（可选）
- 关闭自动定位后，可以手动选择固定城市
- 默认城市：北京
- 支持从全球200+城市数据库中搜索选择
- 支持用户自定义输入城市名称

### 3. 城市选择器功能
- **热门城市快速选择**：显示中国一线、新一线城市
- **智能搜索**：支持中文名、英文名搜索
- **自定义输入**：当数据库中没有所需城市时，用户可以手动输入
- **当前城市提示**：清晰显示当前选择的城市

## 使用场景

### 适合使用自动定位的情况
- 正常网络环境
- 不使用VPN或代理
- 经常移动到不同城市

### 适合使用手动设置的情况
- 使用VPN导致IP定位不准确
- 长期固定在某个城市
- 需要查看特定城市的天气信息

## 技术实现

### 新增文件

1. **models/city.dart**
   - 城市数据模型
   - 支持中英文名称、国家、省份信息
   - 提供搜索匹配方法

2. **services/city_service.dart**
   - 城市数据服务（单例模式）
   - 从JSON文件加载城市数据
   - 提供搜索、筛选等功能
   - 支持创建自定义城市

3. **widgets/city_picker_dialog.dart**
   - 城市选择对话框组件
   - 提供搜索功能
   - 显示热门城市
   - 支持自定义输入

4. **assets/cities.json**
   - 包含200+全球主要城市数据
   - 中国城市：100+（覆盖所有主要城市）
   - 国际城市：100+（覆盖主要国家和地区）

### 修改文件

1. **services/location_service.dart**
   - 添加自动定位开关支持
   - 添加手动城市设置
   - 使用SharedPreferences持久化设置

2. **screens/settings_screen.dart**
   - 添加"位置设置"板块
   - 自动定位开关
   - 手动城市选择按钮
   - VPN提示说明

3. **pubspec.yaml**
   - 注册 cities.json 资源文件

## 数据存储

使用 SharedPreferences 存储以下设置：

- `location_auto_enabled`: 自动定位开关（bool，默认true）
- `location_manual_city`: 手动设置的城市（String，默认"北京"）
- `location_cached_city`: 缓存的城市（String，用于快速启动）

## 设置界面

位置设置位于"设置"页面的独立板块，包含：

1. **自动IP定位开关**
   - 图标：定位图标（绿色）
   - 说明：使用IP地址自动识别当前城市

2. **固定城市选择**（仅在关闭自动定位时显示）
   - 图标：城市图标（蓝色）
   - 显示当前选择的城市
   - 点击打开城市选择器

3. **VPN提示**（仅在关闭自动定位时显示）
   - 橙色提示框
   - 说明关闭自动定位的好处

## 城市数据库

### 中国城市（100+）
- 包含所有直辖市、省会城市、计划单列市
- 涵盖主要地级市
- 包括港澳台地区

### 国际城市（100+）
- 美国、英国、法国、德国、意大利主要城市
- 日本、韩国、新加坡
- 东南亚国家主要城市
- 澳大利亚、加拿大主要城市
- 中东、南亚、欧洲其他国家主要城市

### 数据格式
```json
{
  "name": "城市中文名",
  "nameEn": "English Name",
  "country": "国家",
  "province": "省份/州"
}
```

## 用户体验优化

1. **平滑过渡**：切换定位模式时有提示反馈
2. **智能默认**：首次使用时默认开启自动定位
3. **快速搜索**：城市选择器支持实时搜索
4. **热门城市**：提供常用城市快速选择
5. **自定义支持**：允许输入任意城市名称
6. **清晰提示**：显示当前选择状态和说明

## 注意事项

1. 自动定位依赖IP地址，VPN会影响准确性
2. 手动设置的城市会持久保存，不会因重启丢失
3. 城市数据存储在assets中，应用更新后会自动更新
4. 自定义输入的城市名会直接用于天气API查询

## 未来扩展

可以考虑的增强功能：

1. 支持添加多个常用城市
2. 城市历史记录
3. GPS定位支持（需要定位权限）
4. 城市天气信息预览
5. 时区自动切换
